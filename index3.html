<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Despesas Públicas</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <!-- DataTables Buttons -->
  <link href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css" rel="stylesheet">

  <style>
    body {
      font-size: 0.875rem;
      padding: 2rem;
      background-color: #f9f9f9;
    }

    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .filters select,
    .filters button {
      min-width: 150px;
    }

    #tabela_wrapper {
      margin-top: 2rem;
    }

    table.dataTable th,
    table.dataTable td {
      white-space: nowrap;
    }

    .dt-buttons {
      margin-bottom: 1rem;
    }

    .dataTables_wrapper .dataTables_paginate {
      justify-content: center;
    }

    .table-responsive {
      overflow-x: auto;
    }
  </style>
</head>
<body>

<h2 class="mb-4 text-center">Despesas Públicas</h2>

<div class="filters d-flex align-items-center flex-wrap gap-2 mb-3">
  <select id="anoFiltro" class="form-select form-select-sm" style="width: auto;">
    <option value="">Ano</option>
  </select>

  <select id="mesFiltro" class="form-select form-select-sm" style="width: auto;" disabled>
    <option value="">Mês</option>
  </select>

  <button id="limparFiltros" class="btn btn-secondary btn-sm">Limpar</button>
</div>

<div class="table-responsive d-none" id="tabelaContainer">
  <table id="tabela" class="table table-striped table-bordered nowrap" style="width:100%">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
  const meses = [
    "JANEIRO", "FEVEREIRO", "MARCO", "ABRIL", "MAIO", "JUNHO",
    "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"
  ];

  let dadosOriginais = [];
  let tabela = null;

  function formatarMoeda(valor) {
    if (!valor) return '';
    let num = parseFloat(valor.replace(/\./g, '').replace(',', '.'));
    return isNaN(num) ? valor : num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function popularAnos() {
    const anos = [...new Set(dadosOriginais.map(d => d.ANO))].sort();
    anos.forEach(ano => {
      $('#anoFiltro').append(`<option value="${ano}">${ano}</option>`);
    });
  }

  function popularMeses() {
    meses.forEach(mes => {
      $('#mesFiltro').append(`<option value="${mes}">${mes}</option>`);
    });
    $('#mesFiltro').prop('disabled', false);
  }

  function construirCabecalho(colunas, mesSelecionado) {
    const thead = $('#tabela thead');
    thead.empty();
    let linha = '<tr>';
    colunas.forEach(col => {
      if (!meses.includes(col) && col !== 'TOTAL') {
        linha += `<th>${col}</th>`;
      }
    });
    linha += `<th>${mesSelecionado}</th>`;
    linha += '</tr>';
    thead.append(linha);
  }

  function carregarTabela(dadosFiltrados, mesSelecionado) {
    if (tabela) {
      tabela.destroy();
      $('#tabela tbody').empty();
    }

    if (dadosFiltrados.length === 0) {
      $('#tabelaContainer').addClass('d-none');
      return;
    }

    const colunas = Object.keys(dadosFiltrados[0]);
    construirCabecalho(colunas, mesSelecionado);

    const tbody = $('#tabela tbody');
    dadosFiltrados.forEach(row => {
      let linha = '<tr>';
      colunas.forEach(col => {
        if (!meses.includes(col) && col !== 'TOTAL') {
          linha += `<td>${row[col]}</td>`;
        }
      });
      linha += `<td>${formatarMoeda(row[mesSelecionado])}</td>`;
      linha += '</tr>';
      tbody.append(linha);
    });

    tabela = $('#tabela').DataTable({
      scrollX: true,
      lengthChange: false,
      pageLength: 10,
      ordering: true,
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"
      },
      dom: 'Bfrtip',
      buttons: [
        { extend: 'csv', text: 'CSV' },
        { extend: 'excel', text: 'Excel' },
        { extend: 'copy', text: 'TXT' },
        {
          text: 'JSON',
          action: function () {
            const dados = tabela.rows({ search: 'applied' }).data().toArray();
            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'dados.json';
            link.click();
          }
        }
      ]
    });

    $('#tabelaContainer').removeClass('d-none');
  }

  $(document).ready(function () {
    Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vS9iiIBNEZs9OFuuKDy8N-P6fBDuqxpEYObhYWoR7YDi4DxsHQ7fZEHXs91FYLxCJEJpoJBaEeVYt0t/pub?gid=1659253784&single=true&output=csv', {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        dadosOriginais = results.data.filter(r => r.ANO);
        popularAnos();
      }
    });

    $('#anoFiltro').on('change', function () {
      $('#mesFiltro').empty().append('<option value="">Selecione o mês</option>').prop('disabled', true);
      $('#tabelaContainer').addClass('d-none');
      if ($(this).val()) popularMeses();
    });

    $('#mesFiltro').on('change', function () {
      const ano = $('#anoFiltro').val();
      const mes = $(this).val();
      if (ano && mes) {
        const dadosFiltrados = dadosOriginais.filter(d => d.ANO === ano && d[mes]);
        carregarTabela(dadosFiltrados, mes);
      } else {
        $('#tabelaContainer').addClass('d-none');
      }
    });

    $('#limparFiltros').on('click', function () {
      $('#anoFiltro').val('');
      $('#mesFiltro').empty().append('<option value="">Selecione o mês</option>').prop('disabled', true);
      $('#tabelaContainer').addClass('d-none');
      if (tabela) {
        tabela.clear().destroy();
        $('#tabela tbody').empty();
      }
    });
  });
</script>

</body>
</html>
