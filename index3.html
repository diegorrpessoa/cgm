<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Receita Pública</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
  <style>
    body { padding: 20px; }
    #loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #filters, #dataTable-container {
      display: none;
    }
  </style>
</head>
<body>
  <div id="loading-spinner">
    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>
  </div>

  <div class="container">
    <h2 class="mb-4">Consulta de Receita Pública</h2>

    <div id="filters" class="row g-3 mb-4">
      <div class="col-md-3">
        <label for="yearFilter" class="form-label">Ano (obrigatório)</label>
        <select id="yearFilter" class="form-select">
          <option value="">Selecione o ano</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="monthFilter" class="form-label">Mês</label>
        <select id="monthFilter" class="form-select">
          <option value="">Todos</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="typeFilter" class="form-label">Tipo de Receita</label>
        <select id="typeFilter" class="form-select">
          <option value="">Todos</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="sourceFilter" class="form-label">Fonte</label>
        <select id="sourceFilter" class="form-select">
          <option value="">Todas</option>
        </select>
      </div>
    </div>

    <div id="dataTable-container">
      <table id="dataTable" class="display nowrap table table-striped" style="width:100%">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    let allData = [];
    let dataTable;

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2Fo1dHo7uFDOBtQ0IAOgEONJGUDJzVptV3D-TO3ozp4YmnzjBEUog_AxeEzuzyDpPRu6dtjLw59Ej/pub?output=csv';

    function uniqueValues(data, columnIndex) {
      return [...new Set(data.map(row => row[columnIndex]).filter(val => val))].sort();
    }

    function populateFilter(selectId, values, defaultOption = 'Todos') {
      const select = $(`#${selectId}`);
      select.empty().append(`<option value="">${defaultOption}</option>`);
      values.forEach(val => {
        select.append(`<option value="${val}">${val}</option>`);
      });
    }

    function filterDataByAll() {
      const year = $('#yearFilter').val();
      const month = $('#monthFilter').val();
      const type = $('#typeFilter').val();
      const source = $('#sourceFilter').val();

      return allData.filter(row =>
        (!year || row[0] === year) &&
        (!month || row[1] === month) &&
        (!type || row[2] === type) &&
        (!source || row[3] === source)
      );
    }

    function updateTable(filteredData) {
      if (dataTable) dataTable.destroy();

      const columns = allData[0].map((col, i) => ({ title: allData[0][i] }));

      $('#dataTable thead').empty().append(`<tr>${columns.map(col => `<th>${col.title}</th>`).join('')}</tr>`);
      $('#dataTable tbody').empty().append(
        filteredData.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')
      );

      dataTable = $('#dataTable').DataTable({
        dom: 'Bfrtip',
        buttons: ['csv', 'excel'],
        language: {
          url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"
        },
        scrollX: true
      });
    }

    $(document).ready(() => {
      Papa.parse(csvUrl, {
        download: true,
        complete: function(results) {
          allData = results.data.filter(row => row.length > 1);
          const yearValues = uniqueValues(allData.slice(1), 0);
          populateFilter('yearFilter', yearValues, 'Selecione o ano');
          $('#loading-spinner').hide();
          $('#filters').show();
        }
      });

      $('#yearFilter').on('change', function () {
        const selectedYear = $(this).val();
        if (!selectedYear) {
          $('#dataTable-container').hide();
          return;
        }

        const filteredByYear = allData.filter(row => row[0] === selectedYear);
        const header = allData[0];
        const body = filteredByYear;

        populateFilter('monthFilter', uniqueValues(body, 1));
        populateFilter('typeFilter', uniqueValues(body, 2));
        populateFilter('sourceFilter', uniqueValues(body, 3));

        updateTable([header, ...body]);
        $('#dataTable-container').show();
      });

      $('#monthFilter, #typeFilter, #sourceFilter').on('change', function () {
        const filtered = filterDataByAll();
        updateTable([allData[0], ...filtered]);
      });
    });
  </script>
</body>
</html>
