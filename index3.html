<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tabela com Filtros ANO e MÊS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; padding: 20px; }
    .form-label { font-weight: 600; font-size: 0.85rem; }
    .form-select { max-width: 150px; }
    table.dataTable td, table.dataTable th { white-space: nowrap; }
  </style>
</head>
<body>

<div class="container">
  <h4 class="mb-3">Despesas - Filtro por Ano e Mês</h4>
  
  <div class="row g-3 mb-4 align-items-end">
    <div class="col-auto">
      <label for="anoFiltro" class="form-label">Ano</label>
      <select id="anoFiltro" class="form-select"></select>
    </div>
    <div class="col-auto">
      <label for="mesFiltro" class="form-label">Mês</label>
      <select id="mesFiltro" class="form-select" disabled></select>
    </div>
  </div>
  
  <table id="tabela" class="table table-striped table-bordered" style="width:100%; display:none;">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const mesesOrdem = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
let dadosOriginais = [];
let tabela = null;

// URL do seu CSV — substitua aqui para seu arquivo ou link público
const urlCsv = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzWz42lwpuf2FwYofqSsAgtDayYLAYCblodcAjQvV-pYxFGengPlHWubJjyTP6_6jidIhpQcuLuvC7/pub?gid=501851609&single=true&output=csv";

function popularFiltro(id, campo, dados, ordenarMes=false){
  const select = $('#' + id);
  select.empty().append('<option value="">Todos</option>');
  let valores = [...new Set(dados.map(r => r[campo]).filter(v => v))];
  if(ordenarMes) {
    valores.sort((a,b) => mesesOrdem.indexOf(a) - mesesOrdem.indexOf(b));
  } else {
    valores.sort();
  }
  valores.forEach(v => select.append(`<option value="${v}">${v}</option>`));
  select.prop('disabled', valores.length === 0);
}

function filtrarDados(){
  let ano = $('#anoFiltro').val();
  let mes = $('#mesFiltro').val();
  let filtrados = dadosOriginais;

  if(ano) filtrados = filtrados.filter(r => r["ANO"] === ano);
  if(mes) filtrados = filtrados.filter(r => r["MÊS"] === mes);

  return filtrados;
}

function montarTabela(dados){
  if(dados.length === 0) {
    $('#tabela').hide();
    if(tabela) {
      tabela.clear().draw();
    }
    return;
  }

  $('#tabela').show();

  // Monta cabeçalho com base nas colunas da primeira linha
  const colunas = Object.keys(dados[0]).map(c => ({
    title: c,
    data: c,
    render: (typeof dados[0][c] === 'string' && dados[0][c].startsWith("R$")) ?
      $.fn.dataTable.render.number('.', ',', 2, 'R$ ') : null
  }));

  if(tabela) {
    tabela.clear().rows.add(dados).draw();
  } else {
    tabela = $('#tabela').DataTable({
      data: dados,
      columns: colunas,
      destroy: true,
      pageLength: 10,
      lengthChange: false,
      searching: true,
      ordering: true,
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
      autoWidth: false,
      scrollX: true
    });
  }
}

$(document).ready(() => {
  Papa.parse(urlCsv, {
    download: true,
    header: true,
    complete: function(result){
      dadosOriginais = result.data.filter(r => r["ANO"] && r["MÊS"]);

      popularFiltro("anoFiltro", "ANO", dadosOriginais);
      popularFiltro("mesFiltro", "MÊS", dadosOriginais, true);
      $('#mesFiltro').prop('disabled', true);

      $('#anoFiltro').on('change', function(){
        const anoSelecionado = $(this).val();
        let dadosFiltradosAno = anoSelecionado ? dadosOriginais.filter(r => r["ANO"] === anoSelecionado) : dadosOriginais;
        popularFiltro("mesFiltro", "MÊS", dadosFiltradosAno, true);
        $('#mesFiltro').prop('disabled', false);
        $('#mesFiltro').val('');

        montarTabela(filtrarDados());
      });

      $('#mesFiltro').on('change', function(){
        montarTabela(filtrarDados());
      });

      montarTabela(dadosOriginais);
    }
  });
});
</script>
</body>
</html>
