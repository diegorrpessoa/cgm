<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tabela Moderna e Objetiva</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<!-- DataTables Bootstrap 5 -->
<link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9fafb;
    margin: 2rem auto;
    max-width: 1100px;
    color: #2c3e50;
  }

  h1 {
    font-weight: 700;
    margin-bottom: 1.5rem;
    font-size: 1.8rem;
    text-align: center;
    color: #34495e;
  }

  .filters {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 1.2rem;
  }

  select.form-select {
    min-width: 160px;
    border-radius: 0.4rem;
    border: 1px solid #ced4da;
    transition: border-color 0.2s ease;
  }
  select.form-select:focus {
    border-color: #1abc9c;
    box-shadow: 0 0 8px #1abc9caa;
    outline: none;
  }

  button#exportCsv {
    background-color: #1abc9c;
    border: none;
    color: white;
    font-weight: 600;
    border-radius: 0.4rem;
    padding: 0.35rem 1.2rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button#exportCsv:hover {
    background-color: #16a085;
  }

  .table-wrapper {
    border-radius: 8px;
    box-shadow: 0 4px 10px rgb(0 0 0 / 0.05);
    overflow-x: auto;
    background: white;
  }

  table.dataTable {
    border-collapse: separate !important;
    border-spacing: 0 12px;
    width: 100% !important;
  }

  thead th {
    position: sticky;
    top: 0;
    background: #fff;
    color: #34495e;
    font-weight: 700;
    font-size: 0.95rem;
    padding: 12px 18px;
    border-bottom: 2px solid #ddd;
    box-shadow: inset 0 -2px 5px -2px rgba(0,0,0,0.1);
    z-index: 9;
    text-align: left;
  }

  tbody td {
    padding: 12px 18px;
    color: #555;
    font-size: 0.9rem;
    white-space: nowrap;
  }

  tbody tr {
    background: #fefefe;
    transition: background-color 0.2s ease;
  }
  tbody tr:hover {
    background: #eaf9f6;
  }

  @media (max-width: 768px) {
    .filters {
      flex-direction: column;
      align-items: center;
    }
    select.form-select {
      width: 100%;
      max-width: 300px;
    }
  }
</style>
</head>
<body>

<h1>Resumo de Despesas</h1>

<div class="filters mb-3" role="search" aria-label="Filtros da tabela">
  <select id="anoFiltro" class="form-select" aria-label="Filtro por Ano">
    <option value="">Selecione o Ano</option>
  </select>

  <select id="mesFiltro" class="form-select" aria-label="Filtro por Mês" disabled>
    <option value="">Selecione o Mês</option>
  </select>

  <button id="exportCsv" disabled aria-disabled="true" title="Exportar dados filtrados CSV">Exportar CSV</button>
</div>

<div class="table-wrapper" role="region" aria-live="polite" aria-atomic="true">
  <table id="tabela" class="table dataTable" style="display:none;"></table>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
  const meses = [
    "JANEIRO","FEVEREIRO","MARÇO","ABRIL","MAIO","JUNHO",
    "JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"
  ];

  let dadosOriginais = [];
  let tabela = null;

  function formatarMoedaBR(valorStr) {
    if (!valorStr) return "";
    // Remove pontos e troca vírgula por ponto pra converter número
    let valorNum = parseFloat(valorStr.replace(/\./g, "").replace(",", "."));
    if (isNaN(valorNum)) return valorStr;
    return valorNum.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  function limparTabela() {
    if (tabela) {
      tabela.clear().destroy();
      tabela = null;
    }
    $("#tabela").hide();
    $("#exportCsv").prop("disabled", true).attr("aria-disabled", "true");
  }

  function montarTabela(dados, mesSelecionado) {
    if (tabela) {
      tabela.clear().destroy();
    }

    // Colunas fixas + coluna do mês (valor formatado)
    let colunasExibir = [
      { title: "ANO", data: "ANO" },
      { title: "CATEGORIA ECONÔMICA", data: "NOME CATEGORIA ECONOMICA" },
      { title: "ORIGEM", data: "NOME ORIGEM" },
      { title: "ESPÉCIE", data: "NOME ESPECIE" },
      { title: "NATUREZA", data: "NOME NATUREZA" },
      {
        title: mesSelecionado.charAt(0).toUpperCase() + mesSelecionado.slice(1).toLowerCase(),
        data: mesSelecionado,
        render: formatarMoedaBR,
        className: "text-end"
      }
    ];

    tabela = $("#tabela").DataTable({
      data: dados,
      columns: colunasExibir,
      paging: true,
      pageLength: 15,
      lengthChange: false,
      searching: false,
      ordering: true,
      info: true,
      autoWidth: false,
      scrollX: true,
      dom: "Bfrtip",
      buttons: [
        {
          extend: "csvHtml5",
          text: "Exportar CSV",
          filename: `dados_${mesSelecionado.toLowerCase()}`,
          exportOptions: {
            columns: ":visible"
          }
        }
      ],
      language: {
        emptyTable: "Nenhum dado encontrado para o filtro selecionado",
        info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
        infoEmpty: "Mostrando 0 a 0 de 0 registros",
        paginate: {
          first: "Primeiro",
          last: "Último",
          next: "Próximo",
          previous: "Anterior"
        }
      },
      initComplete: function() {
        $("#tabela").show();
        $("#exportCsv").prop("disabled", false).attr("aria-disabled", "false");
      }
    });
  }

  $(document).ready(() => {
    // Carregar CSV pelo PapaParse
    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vS9iiIBNEZs9OFuuKDy8N-P6fBDuqxpEYObhYWoR7YDi4DxsHQ7fZEHXs91FYLxCJEJpoJBaEeVYt0t/pub?gid=1659253784&single=true&output=csv", {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (res) => {
        dadosOriginais = res.data.filter(r => r["ANO"]);
        let anos = [...new Set(dadosOriginais.map(r => r["ANO"]))].sort();
        anos.forEach(ano => $("#anoFiltro").append(`<option value="${ano}">${ano}</option>`));
      }
    });

    $("#anoFiltro").on("change", () => {
      const ano = $("#anoFiltro").val();
      $("#mesFiltro").prop("disabled", true).val("").html('<option value="">Selecione o Mês</option>');
      limparTabela();

      if (!ano) return;

      meses.forEach(mes => {
        $("#mesFiltro").append(`<option value="${mes}">${mes.charAt(0) + mes.slice(1).toLowerCase()}</option>`);
      });

      $("#mesFiltro").prop("disabled", false);
    });

    $("#mesFiltro").on("change", () => {
      const ano = $("#anoFiltro").val();
      const mes = $("#mesFiltro").val();

      if (!ano || !mes) {
        limparTabela();
        return;
      }

      // Filtra linhas que possuem valor no mês selecionado
      const dadosFiltrados = dadosOriginais.filter(r => r["ANO"] === ano && r[mes] && r[mes].trim() !== "");

      if (!dadosFiltrados.length) {
        limparTabela();
        return;
      }

      montarTabela(dadosFiltrados, mes);
    });

    $("#exportCsv").on("click", () => {
      tabela?.button('.buttons-csv').trigger();
    });
  });
</script>
</body>
</html>
