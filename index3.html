<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Receitas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css"/>
  <style>
    body { background-color: #f8f9fa; }
    .form-label, .form-select-sm, .form-control-sm, .table th, .table td {
      font-size: 0.65rem !important;
    }
    .xsmall { font-size: 0.6rem !important; }
    .spinner-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      justify-content: flex-start; padding-top: 60px; z-index: 9999;
      background-color: rgba(255, 255, 255, 0.9);
    }
  </style>
</head>
<body>
<div id="spinnerCsv" class="spinner-overlay">
  <div class="spinner-border text-primary"></div>
  <div class="spinner-text">Carregando dados de receitas...</div>
</div>

<div class="container-fluid mt-4">
  <div class="row gx-2 gy-2 mb-3">
    <div class="col-sm-2"><label class="form-label">Ano</label><select id="anoFiltro" class="form-select form-select-sm"></select></div>
    <div class="col-sm-2"><label class="form-label">Mês</label><select id="mesFiltro" class="form-select form-select-sm" disabled></select></div>
  </div>

  <div class="table-responsive">
    <table id="tabela" class="table table-bordered table-striped table-sm xsmall w-100" style="display:none;"></table>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
let tabela, dadosOriginais = [];
const mesesOrdem = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

$(document).ready(function(){
  Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vS9iiIBNEZs9OFuuKDy8N-P6fBDuqxpEYObhYWoR7YDi4DxsHQ7fZEHXs91FYLxCJEJpoJBaEeVYt0t/pub?output=csv", {
    download: true,
    header: true,
    complete: function(res){
      dadosOriginais = res.data.filter(r => r["Ano"]);
      popularFiltro("anoFiltro", "Ano", dadosOriginais);
      $('#spinnerCsv').hide();

      $('#anoFiltro').on('change', function(){
        const ano = $(this).val();
        const base = ano ? dadosOriginais.filter(r => r["Ano"] === ano) : dadosOriginais;
        popularFiltro("mesFiltro", "Mês", base);
        $('#mesFiltro').prop('disabled', false);
        aplicarFiltros();
      });

      $('#mesFiltro').on('change', aplicarFiltros);
    }
  });
});

function popularFiltro(id, campo, dados){
  const s = $('#' + id);
  s.empty().append('<option value="">Todos</option>');
  let valores = [...new Set(dados.map(r => r[campo]).filter(v => v))];
  if(campo === "Mês") valores.sort((a,b)=>mesesOrdem.indexOf(a)-mesesOrdem.indexOf(b));
  else valores.sort();
  valores.forEach(v => s.append(`<option value="${v}">${v}</option>`));
}

function aplicarFiltros(){
  const ano = $('#anoFiltro').val();
  const mes = $('#mesFiltro').val();
  let dados = dadosOriginais;
  if(ano) dados = dados.filter(r => r["Ano"] === ano);
  if(mes) dados = dados.filter(r => r["Mês"] === mes);
  inicializarTabela(dados);
}

function inicializarTabela(dados){
  $('#tabela').show();
  if(tabela){
    tabela.clear().rows.add(dados).draw();
  } else {
    const colunas = Object.keys(dados[0]).map(c => ({ title: c, data: c }));
    tabela = $('#tabela').DataTable({
      data: dados,
      columns: colunas,
      destroy: true,
      pageLength: 10,
      searching: true,
      ordering: true,
      autoWidth: false,
      scrollX: true,
      dom: 'Bfrtip',
      buttons: [
        { extend: 'csvHtml5', className: 'btn btn-sm btn-outline-secondary' },
        { extend: 'excelHtml5', className: 'btn btn-sm btn-outline-secondary' }
      ],
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" }
    });
  }
}
</script>
</body>
</html>
