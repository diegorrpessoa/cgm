<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Receitas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css"/>
  <style>
    .spinner-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    .spinner-text {
      margin-top: 10px;
      font-size: 1.2rem;
      color: #333;
    }
    .totalizadores span {
      margin-right: 20px;
      font-weight: bold;
    }
    .xsmall {
      font-size: 0.75rem;
    }
  </style>
</head>
<body>

<div id="spinnerCsv" class="spinner-overlay">
  <div class="spinner-border text-success"></div>
  <div class="spinner-text">Carregando dados de receitas...</div>
</div>

<div class="container-fluid mt-4">
  <div class="row gx-2 gy-2 mb-3">
    <div class="col-sm-2">
      <label>Ano *</label>
      <select id="anoFiltro" class="form-select form-select-sm"></select>
    </div>
  </div>

  <div class="table-wrapper">
    <table id="tabela" class="table table-bordered table-striped table-sm xsmall w-100" style="display:none;"></table>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
let dadosCsv = [];
let tabela;

const carregarCsv = (url) => {
  Papa.parse(url, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      dadosCsv = results.data.filter(row => row["Ano"]);
      popularFiltroAno(dadosCsv);
      inicializarTabela(dadosCsv);
      $('#spinnerCsv').hide();
    },
    error: function(err) {
      alert("Erro ao carregar CSV: " + err);
      $('#spinnerCsv').hide();
    }
  });
};

const popularFiltroAno = (dados) => {
  const anos = [...new Set(dados.map(row => row["Ano"]).filter(Boolean))].sort();
  const select = $('#anoFiltro');
  select.empty().append('<option value="">Todos</option>');
  anos.forEach(ano => select.append(`<option value="${ano}">${ano}</option>`));
};

const aplicarFiltroAno = () => {
  const anoSelecionado = $('#anoFiltro').val();
  return anoSelecionado ? dadosCsv.filter(row => row["Ano"] === anoSelecionado) : dadosCsv;
};

const inicializarTabela = (dados) => {
  if (tabela) {
    tabela.clear().rows.add(dados).draw();
    return;
  }
  const colunas = Object.keys(dados[0] || {}).map(col => ({ title: col, data: col }));
  tabela = $('#tabela').DataTable({
    data: dados,
    columns: colunas,
    dom: 'Bfrtip',
    buttons: ['csv', 'excel'],
    language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
    pageLength: 10
  });
  $('#tabela').show();
};

$('#anoFiltro').on('change', function () {
  const filtrado = aplicarFiltroAno();
  inicializarTabela(filtrado);
});

const urlCsv = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2Fo1dHo7uFDOBtQ0IAOgEONJGUDJzVptV3D-TO3ozp4YmnzjBEUog_AxeEzuzyDpPRu6dtjLw59Ej/pub?output=csv";
carregarCsv(urlCsv);
</script>
</body>
</html>
