<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css"/>
  <style>
    body { background-color: #f8f9fa; font-size:0.75rem; }
    .form-select-sm, .btn-sm { font-size:0.75rem; height:32px; }
    label { font-weight:500; font-size:0.75rem; }
    .table th, .table td { white-space: nowrap; }
    .dataTables_filter { display:none !important; }
    .spinner-overlay {
      position:fixed; top:0; left:0; width:100%; height:100vh;
      background:rgba(255,255,255,0.9);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
    }
    .table-wrapper { overflow-x:auto; }
  </style>
</head>
<body>
  <div id="spinnerCsv" class="spinner-overlay">
    <div class="text-center">
      <div class="spinner-border text-primary"></div>
      <div class="mt-2">Carregando dados...</div>
    </div>
  </div>

  <div class="container-fluid mt-4">
    <div class="row g-2 mb-2">
      <div class="col-sm-2">
        <label for="anoFiltro">Ano</label>
        <select id="anoFiltro" class="form-select form-select-sm"></select>
      </div>
      <div class="col-sm-2">
        <label for="mesFiltro">Mês</label>
        <select id="mesFiltro" class="form-select form-select-sm" disabled>
          <option value="">Selecione o ano</option>
        </select>
      </div>
      <div class="col-sm-2 d-flex align-items-end">
        <button id="btnLimpar" class="btn btn-outline-secondary btn-sm w-100" disabled>Limpar</button>
      </div>
      <div class="col-sm-4 d-flex align-items-end">
        <div class="btn-group w-100">
          <button id="exportCsv" class="btn btn-outline-primary btn-sm" disabled>CSV</button>
          <button id="exportXls" class="btn btn-outline-primary btn-sm" disabled>XLS</button>
          <button id="exportJson" class="btn btn-outline-primary btn-sm" disabled>JSON</button>
          <button id="exportTxt" class="btn btn-outline-primary btn-sm" disabled>Copiar</button>
        </div>
      </div>
    </div>

    <div class="table-wrapper mt-3">
      <table id="tabela" class="table table-bordered table-striped table-sm w-100" style="display:none;"></table>
    </div>

    <div id="lengthSelectorContainer" class="d-flex justify-content-end mt-2" style="display:none;">
      <label for="lengthSelector" class="me-2">Linhas por página:</label>
      <select id="lengthSelector" class="form-select form-select-sm" style="width:80px;">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    let tabela, dadosOriginais = [];

    $(document).ready(() => {
      Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vS9iiIBNEZs9OFuuKDy8N-P6fBDuqxpEYObhYWoR7YDi4DxsHQ7fZEHXs91FYLxCJEJpoJBaEeVYt0t/pub?gid=1659253784&output=csv", {
        download:true, header:true,
        complete: res => {
          dadosOriginais = res.data.filter(r => r.ANO);
          const anos = [...new Set(dadosOriginais.map(r => r.ANO))].sort();
          $('#anoFiltro').append(`<option value="">Selecione</option>` + anos.map(a=>`<option value="${a}">${a}</option>`).join(''));
          $('#spinnerCsv').hide();
        }
      });

      $('#anoFiltro').change(() => {
        const ano = $('#anoFiltro').val();
        $('#mesFiltro').prop('disabled', !ano).html(ano ? `<option value="">Selecione</option>` : `<option value="">Selecione o ano</option>`);
        if (!ano) return;
        const meses = ["JANEIRO","FEVEREIRO","MARCO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"];
        meses.forEach(m => $('#mesFiltro').append(`<option value="${m}">${m.charAt(0)+m.slice(1).toLowerCase()}</option>`));
      });

      $('#mesFiltro').change(() => {
        const ano = $('#anoFiltro').val(); const mes = $('#mesFiltro').val();
        if (!ano || !mes) return;
        const dados = dadosOriginais.filter(r => r.ANO === ano && r[mes] && !isNaN(parseFloat(r[mes])));
        renderizarTabela(dados, mes);
        $('#btnLimpar, #exportCsv, #exportXls, #exportJson, #exportTxt').prop('disabled', false);
      });

      $('#btnLimpar').click(() => {
        $('#anoFiltro, #mesFiltro').val('');
        $('#mesFiltro').prop('disabled', true);
        tabela?.clear().draw();
        $('#tabela, #lengthSelectorContainer').hide();
        $('#btnLimpar, #exportCsv, #exportXls, #exportJson, #exportTxt').prop('disabled', true);
      });

      $('#exportCsv').click(() => tabela.button('.buttons-csv').trigger());
      $('#exportXls').click(() => tabela.button('.buttons-excel').trigger());
      $('#exportJson').click(() => tabela.button('.buttons-json').trigger());
      $('#exportTxt').click(() => tabela.button('.buttons-txt').trigger());
    });

    function renderizarTabela(dados, mesSelecionado) {
      $('#lengthSelectorContainer').show();
      const tam = parseInt($('#lengthSelector').val()) || 10;
      tabela?.destroy();

      const colunasMes = ["JANEIRO","FEVEREIRO","MARCO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"];
      const cabeçalhos = Object.keys(dados[0]).filter(c => !colunasMes.includes(c) || c === mesSelecionado);
      const cols = cabeçalhos.map(c => ({
        title: c,
        data: c,
        render: /PREVISAO|TOTAL|JANEIRO|FEVEREIRO|MARCO|ABRIL|MAIO|JUNHO|JULHO|AGOSTO|SETEMBRO|OUTUBRO|NOVEMBRO|DEZEMBRO/.test(c)
          ? $.fn.dataTable.render.number('.', ',', 2, 'R$ ')
          : null
      }));

      tabela = $('#tabela').DataTable({
        data: dados,
        columns: cols,
        paging: true,
        pageLength: tam,
        ordering: true,
        searching: false,
        info: true,
        dom: 'Bfrtip',
        buttons: [
          { extend:'csvHtml5', className:'buttons-csv d-none' },
          { extend:'excelHtml5', className:'buttons-excel d-none' },
          { extend:'copyHtml5', className:'buttons-txt d-none' },
          {
            extend:'jsonHtml5', className:'buttons-json d-none',
            action: (e, dt) => {
              const blob = new Blob([JSON.stringify(dt.buttons.exportData().body)], { type:'application/json' });
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = "dados.json";
              a.click();
            }
          }
        ],
        language: { url:"https://cdn.datatables.net/plug‑ins/1.13.4/i18n/pt‑BR.json" }
      });

      $('#tabela').show();
      $('#lengthSelector').off().change(() => tabela.page.len(parseInt($('#lengthSelector').val())).draw());
    }
  </script>
</body>
</html>
