<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tabela Despesas - UX Fluida</title>

<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<!-- DataTables CSS Bootstrap 5 -->
<link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css" rel="stylesheet" />

<style>
  body {
    background: #f8f9fa;
    padding: 2rem;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }

  h2 {
    margin-bottom: 1.5rem;
    color: #212529;
    text-align: center;
  }

  .filters {
    max-width: 600px;
    margin: 0 auto 1.5rem auto;
    display: flex;
    gap: 1rem;
  }

  .filters select {
    flex: 1;
  }

  /* Cabeçalho fixo DataTables */
  table.dataTable thead th {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 10;
    box-shadow: 0 2px 3px rgb(0 0 0 / 0.1);
  }
</style>
</head>
<body>

<h2>Despesas Públicas - Filtro Ano e Mês</h2>

<div class="filters" role="region" aria-label="Filtros de ano e mês">
  <select id="anoFiltro" class="form-select" aria-label="Filtro por ano">
    <option value="">Selecione o Ano</option>
  </select>
  <select id="mesFiltro" class="form-select" aria-label="Filtro por mês" disabled>
    <option value="">Selecione o Mês</option>
  </select>
</div>

<div class="table-responsive">
  <table id="tabela" class="table table-striped table-bordered nowrap" style="width:100%">
    <thead>
      <tr>
        <th>ANO</th>
        <th>CATEGORIA ECONÔMICA</th>
        <th>ORIGEM</th>
        <th>ESPÉCIE</th>
        <th>NATUREZA</th>
        <th>VALOR</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- JS libs -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
  const meses = [
    "JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO",
    "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"
  ];

  let dadosOriginais = [];
  let tabela = null;

  function formatarMoedaBR(valor) {
    if (!valor) return "";
    // Converte texto para número com ponto decimal
    let num = parseFloat(valor.replace(/\./g, '').replace(',', '.'));
    if (isNaN(num)) return valor;
    return num.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
  }

  // Inicializa selects e tabela
  function popularAnos() {
    const anos = [...new Set(dadosOriginais.map(d => d.ANO))].sort();
    anos.forEach(ano => {
      $('#anoFiltro').append(`<option value="${ano}">${ano}</option>`);
    });
  }

  function popularMeses() {
    meses.forEach(mes => {
      $('#mesFiltro').append(`<option value="${mes}">${mes.charAt(0)+mes.slice(1).toLowerCase()}</option>`);
    });
    $('#mesFiltro').prop('disabled', false);
  }

  function carregarTabela(dados, mes) {
    if (tabela) {
      tabela.clear().destroy();
    }

    tabela = $('#tabela').DataTable({
      data: dados,
      columns: [
        { data: 'ANO' },
        { data: 'NOME CATEGORIA ECONOMICA' },
        { data: 'NOME ORIGEM' },
        { data: 'NOME ESPECIE' },
        { data: 'NOME NATUREZA' },
        { data: mes, render: formatarMoedaBR, className: 'text-end' }
      ],
      pageLength: 10,
      lengthChange: false,
      ordering: true,
      searching: false,
      responsive: true,
      dom: 'Bfrtip',
      buttons: [
        {
          extend: 'csvHtml5',
          text: 'Exportar CSV',
          filename: `despesas_${mes.toLowerCase()}`,
          exportOptions: { columns: ':visible' }
        }
      ],
      language: {
        emptyTable: "Nenhum dado para exibir",
        paginate: {
          previous: "Anterior",
          next: "Próximo"
        },
        info: "Mostrando _START_ a _END_ de _TOTAL_ registros"
      }
    });
  }

  $(document).ready(function () {
    // Carregar CSV usando PapaParse (atualize o link do CSV conforme seu arquivo)
    Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vS9iiIBNEZs9OFuuKDy8N-P6fBDuqxpEYObhYWoR7YDi4DxsHQ7fZEHXs91FYLxCJEJpoJBaEeVYt0t/pub?gid=1659253784&single=true&output=csv', {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        dadosOriginais = results.data.filter(r => r.ANO);
        popularAnos();
      }
    });

    $('#anoFiltro').on('change', function () {
      const anoSelecionado = $(this).val();
      $('#mesFiltro').empty().append('<option value="">Selecione o Mês</option>').prop('disabled', true);
      if (tabela) {
        tabela.clear().destroy();
        $('#tabela tbody').empty();
      }
      if (anoSelecionado) {
        popularMeses();
      }
    });

    $('#mesFiltro').on('change', function () {
      const ano = $('#anoFiltro').val();
      const mes = $(this).val();
      if (!ano || !mes) {
        if (tabela) {
          tabela.clear().destroy();
          $('#tabela tbody').empty();
        }
        return;
      }
      // Filtrar dados por ano e que tenham valor no mês selecionado
      const filtrados = dadosOriginais.filter(item => item.ANO === ano && item[mes] && item[mes].trim() !== '');
      carregarTabela(filtrados, mes);
    });
  });
</script>

</body>
</html>
