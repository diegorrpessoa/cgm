<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Filtrar Receita por Ano e Mês</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css"/>
  <style>
    body { background-color: #f8f9fa; }
    .dataTables_filter { display: none; }
    .form-label, .form-select-sm, .table th, .table td { font-size: 0.75rem !important; }
    .spinner-overlay {
      position: fixed; top: 0; left: 0; width:100%; height:100vh;
      display:flex; flex-direction:column; align-items:center;
      justify-content:flex-start; padding-top:60px; z-index:9999;
      background-color: rgba(255,255,255,0.9);
    }
    .spinner-border { width:2rem; height:2rem; }
    .spinner-text { margin-top:5px; font-size:0.9rem; }
    .table-wrapper { overflow-x: auto; }
    #lengthSelectorContainer {
      margin-top:10px; font-size:0.75rem;
      display:flex; justify-content:flex-end; align-items:center; gap:8px;
    }
    #lengthSelector { width:80px; padding:2px 4px; }
  </style>
</head>
<body>
  <div id="spinnerCsv" class="spinner-overlay">
    <div class="spinner-border text-primary"></div>
    <div class="spinner-text">Carregando dados...</div>
  </div>

  <div class="container-fluid mt-4">
    <div class="row gx-2 gy-2 mb-3">
      <div class="col-sm-2">
        <label for="anoFiltro">Ano *</label>
        <select id="anoFiltro" class="form-select form-select-sm"></select>
      </div>
      <div class="col-sm-2">
        <label for="mesFiltro">Mês *</label>
        <select id="mesFiltro" class="form-select form-select-sm" disabled>
          <option value="">Selecione o mês</option>
        </select>
      </div>
    </div>

    <div class="d-flex justify-content-between mb-2">
      <button id="btnLimpar" class="btn btn-outline-primary btn-sm" disabled>Limpar Filtro</button>
      <div class="btn-group">
        <button id="exportCsv" class="btn btn-outline-secondary btn-sm" disabled>Exportar CSV</button>
        <button id="exportXls" class="btn btn-outline-secondary btn-sm" disabled>Exportar XLS</button>
      </div>
    </div>

    <div class="table-wrapper">
      <table id="tabela" class="table table-bordered table-striped table-sm w-100" style="display:none;"></table>
    </div>

    <div id="lengthSelectorContainer" style="display:none;">
      <label for="lengthSelector">Registros por página:</label>
      <select id="lengthSelector" class="form-select form-select-sm">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Meses na ordem cronológica para exibir no filtro
    const meses = [
      "JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO",
      "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"
    ];

    let dadosOriginais = [], tabela = null;

    $(document).ready(function () {
      // Carregar CSV (altere a URL para o seu arquivo CSV real)
      Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vS9iiIBNEZs9OFuuKDy8N-P6fBDuqxpEYObhYWoR7YDi4DxsHQ7fZEHXs91FYLxCJEJpoJBaEeVYt0t/pub?gid=1659253784&single=true&output=csv", {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (res) {
          dadosOriginais = res.data.filter(r => r["ANO"]);
          const anos = [...new Set(dadosOriginais.map(r => r["ANO"]))].sort();
          $('#anoFiltro').append('<option value="">Selecione</option>');
          anos.forEach(ano => $('#anoFiltro').append(`<option value="${ano}">${ano}</option>`));
          $('#spinnerCsv').hide();
        }
      });

      // Ao mudar o filtro de Ano, preencher o filtro Mês e habilitar
      $('#anoFiltro').on('change', function () {
        const anoSelecionado = $(this).val();

        $('#mesFiltro').empty().append('<option value="">Selecione o mês</option>').prop('disabled', true);
        limparTabela();

        if (!anoSelecionado) {
          $('#btnLimpar').prop('disabled', true);
          return;
        }

        meses.forEach(mes => {
          // Só adiciona se a coluna existir no dado (garantir existência da coluna)
          if (dadosOriginais.length && dadosOriginais[0].hasOwnProperty(mes)) {
            $('#mesFiltro').append(`<option value="${mes}">${mes}</option>`);
          }
        });
        $('#mesFiltro').prop('disabled', false);
        $('#btnLimpar').prop('disabled', false);
      });

      // Ao mudar o filtro de Mês, filtrar e mostrar tabela
      $('#mesFiltro').on('change', function () {
        const ano = $('#anoFiltro').val();
        const mes = $(this).val();

        if (!ano || !mes) {
          limparTabela();
          return;
        }

        // Filtra dados pelo ano e valor do mês não vazio
        const dadosFiltrados = dadosOriginais.filter(r => r["ANO"] === ano && r[mes] && r[mes].trim() !== "");

        if (!dadosFiltrados.length) {
          limparTabela();
          return;
        }

        // Mapear para exibir CATEGORIA ECONOMICA, NOME CATEGORIA ECONOMICA e o valor do mês
        const dadosParaTabela = dadosFiltrados.map(r => ({
          categoriaEconomica: r["CATEGORIA ECONOMICA"] || "",
          nomeCategoriaEconomica: r["NOME CATEGORIA ECONOMICA"] || "",
          valorMes: parseFloat(r[mes].replace(/\./g, '').replace(',', '.')) || 0
        }));

        // Renderizar a tabela
        renderizarTabela(dadosParaTabela, mes);
      });

      // Botão limpar
      $('#btnLimpar').on('click', () => {
        $('#anoFiltro').val('');
        $('#mesFiltro').val('').empty().append('<option value="">Selecione o mês</option>').prop('disabled', true);
        limparTabela();
        $('#btnLimpar, #exportCsv, #exportXls').prop('disabled', true);
      });

      // Exportar CSV e XLS
      $('#exportCsv').on('click', () => tabela?.button('.buttons-csv').trigger());
      $('#exportXls').on('click', () => tabela?.button('.buttons-excel').trigger());
    });

    function limparTabela() {
      if (tabela) {
        tabela.clear().draw();
        tabela.destroy();
        tabela = null;
      }
      $('#tabela').hide();
      $('#lengthSelectorContainer').hide();
    }

    function renderizarTabela(dados, mes) {
      if (tabela) {
        tabela.clear().draw();
        tabela.destroy();
      }

      tabela = $('#tabela').DataTable({
        data: dados,
        columns: [
          { title: "CATEGORIA ECONOMICA", data: "categoriaEconomica" },
          { title: "NOME CATEGORIA ECONOMICA", data: "nomeCategoriaEconomica" },
          {
            title: `VALOR - ${mes}`,
            data: "valorMes",
            render: $.fn.dataTable.render.number('.', ',', 2, 'R$ ')
          }
        ],
        paging: true,
        pageLength: 10,
        searching: false,
        ordering: true,
        dom: 'Bfrtip',
        buttons: [
          { extend: 'csvHtml5', className: 'buttons-csv d-none', filename: `dados_${mes.toLowerCase()}` },
          { extend: 'excelHtml5', className: 'buttons-excel d-none', filename: `dados_${mes.toLowerCase()}` }
        ],
        language: { url: "https://cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" }
      });

      $('#tabela').show();
      $('#exportCsv, #exportXls').prop('disabled', false);
      $('#lengthSelectorContainer').show();

      $('#lengthSelector').off().on('change', function () {
        const len = parseInt($(this).val());
        tabela.page.len(len).draw();
      });
    }
  </script>
</body>
</html>
