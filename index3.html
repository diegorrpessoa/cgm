<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Despesas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css"/>
  <style>
    /* (estilos mantidos inalterados) */
  </style>
</head>
<body>

<div id="spinnerCsv" class="spinner-overlay">
  <div class="spinner-border text-primary"></div>
  <div class="spinner-text">Atualizando dados iniciais...</div>
</div>
<div id="spinnerAno" class="spinner-overlay-ano" style="display:none;">
  <div class="spinner-border text-secondary"></div>
  <div class="spinner-text">Carregando filtros...</div>
</div>

<div class="container-fluid mt-4">
  <div class="row gx-2 gy-2 mb-3">
    <div class="col-sm-2"><label>Ano *</label><select id="anoFiltro" class="form-select form-select-sm"></select></div>
    <div class="col-sm-2"><label>Mês</label><select id="mesFiltro" class="form-select form-select-sm" disabled></select></div>
    <div class="col-sm-2"><label>Unidade</label><select id="unidadeFiltro" class="form-select form-select-sm" disabled></select></div>
    <div class="col-sm-2"><label>Natureza</label><select id="naturezaFiltro" class="form-select form-select-sm" disabled></select></div>
    <div class="col-sm-2"><label>Classificação</label><select id="classificacaoFiltro" class="form-select form-select-sm" disabled></select></div>
    <div class="col-sm-2"><label>Fonte</label><select id="fonteFiltro" class="form-select form-select-sm" disabled></select></div>
    <div class="col-sm-2"><label>Empenho</label><select id="empenhoFiltro" class="form-select form-select-sm" disabled></select></div>
    <div class="col-sm-2"><label>CPF/CNPJ</label><select id="cpfFiltro" class="form-select form-select-sm" disabled></select></div>
    <div class="col-sm-2"><label>Credor</label><select id="credorFiltro" class="form-select form-select-sm" disabled></select></div>
  </div>

  <div class="totalizadores mb-2" id="resumoValores" style="display: none;">
    <span id="totalEmpenhado">Empenhado: R$ 0,00</span>
    <span id="totalLiquidado">Liquidado: R$ 0,00</span>
    <span id="totalPago">Pago: R$ 0,00</span>
  </div>

  <div class="d-flex justify-content-between mb-2">
    <button id="btnLimpar" class="btn btn-outline-primary btn-sm">Limpar Filtros</button>
    <div class="btn-group">
      <button id="exportCsv" class="btn btn-outline-secondary btn-sm">CSV</button>
      <button id="exportXls" class="btn btn-outline-secondary btn-sm">XLS</button>
      <button id="exportJson" class="btn btn-outline-secondary btn-sm">JSON</button>
      <button id="exportTxt" class="btn btn-outline-secondary btn-sm">TXT</button>
    </div>
  </div>

  <div class="table-wrapper">
    <table id="tabela" class="table table-bordered table-striped table-sm xsmall w-100" style="display:none;"></table>
  </div>

  <div id="lengthSelectorContainer" class="text-end">
    <label for="lengthSelector">Registros por página:</label>
    <select id="lengthSelector" class="form-select form-select-sm d-inline-block" aria-label="Selecionar número de registros">
      <option value="10">10</option>
      <option value="20">20</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>
  </div>

</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// (todo o código JS original permanece)
// Acrescenta tratamento especial para que os filtros só se ativem após seleção de ano

$('#anoFiltro').on('change', function(){
  const anoSelecionado = $(this).val();
  if (anoSelecionado) {
    ordemFiltros.slice(1).forEach(f => $('#'+f+'Filtro').prop('disabled', false));
    const df = aplicarFiltroEncadeado();
    inicializarTabela(df);
    atualizarFiltrosEncadeados("ano");
  } else {
    ordemFiltros.slice(1).forEach(f => $('#'+f+'Filtro').prop('disabled', true).val(''));
    $('#resumoValores').hide();
    $('#tabela').hide();
    tabela?.clear().draw();
  }
});
</script>
</body>
</html>
