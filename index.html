<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Execução Orçamentária</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      font-size: 11px;
      margin: 0;
      padding: 1em;
    }
    .spinner, .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 9999;
    }
    .overlay {
      background: rgba(255, 255, 255, 0.7);
    }
    .spinner::before {
      content: 'Carregando...';
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ffffff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: small;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
      margin-bottom: 1em;
      align-items: center;
    }
    .filter-label {
      font-weight: bold;
    }
    select {
      font-size: 11px;
    }
    #totais {
      margin-left: auto;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 2px 5px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    .update-time {
      font-style: italic;
      font-size: 10px;
      margin-bottom: 0.5em;
    }
  </style>
</head>
<body>
  <div class="overlay" id="loadingOverlay"></div>
  <div class="spinner" id="loadingSpinner"></div>

  <div class="update-time" id="dataAtualizacao"></div>

  <div class="filters">
    <label class="filter-label">Ano:</label>
    <select id="filtroAno"></select>

    <label class="filter-label">Unidade Orçamentária:</label>
    <select id="filtroUnidade"></select>

    <label class="filter-label">Natureza de Despesa:</label>
    <select id="filtroNatureza"></select>

    <label class="filter-label">Classificação:</label>
    <select id="filtroClassificacao"></select>

    <label class="filter-label">Fonte:</label>
    <select id="filtroFonte"></select>

    <label class="filter-label">Empenho:</label>
    <select id="filtroEmpenho"></select>

    <label class="filter-label">CPF/CNPJ:</label>
    <select id="filtroCPF"></select>

    <label class="filter-label">Credor:</label>
    <select id="filtroCredor"></select>

    <div id="totais"></div>
  </div>

  <table id="tabelaDados"></table>

  <script>
    const urlCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTzWz42lwpuf2FwYofqSsAgtDayYLAYCblodcAjQvV-pYxFGengPlHWubJjyTP6_6jidIhpQcuLuvC7/pub?gid=501851609&single=true&output=csv';

    let dadosOriginais = [];

    function formatarMoeda(valor) {
      return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function parseValor(valorStr) {
      if (!valorStr) return 0;
      return parseFloat(valorStr.replace('R$', '').replace(/\./g, '').replace(',', '.')) || 0;
    }

    function mostrarCarregando() {
      document.getElementById('loadingOverlay').style.display = 'block';
      document.getElementById('loadingSpinner').style.display = 'block';
    }

    function ocultarCarregando() {
      document.getElementById('loadingOverlay').style.display = 'none';
      document.getElementById('loadingSpinner').style.display = 'none';
    }

    async function carregarDados() {
      mostrarCarregando();
      const resposta = await fetch(urlCSV);
      const texto = await resposta.text();
      const linhas = texto.trim().split('\n').map(l => l.split(','));
      const colunas = linhas.shift();
      dadosOriginais = linhas.map(linha => {
        let obj = {};
        colunas.forEach((col, i) => obj[col.trim()] = linha[i]?.trim());
        return obj;
      });
      atualizarData();
      popularFiltros();
      atualizarTabela();
      ocultarCarregando();
    }

    function atualizarData() {
      const campoData = dadosOriginais.find(l => l['Última Atualização']);
      if (campoData) {
        document.getElementById('dataAtualizacao').innerText = 'Atualizado em: ' + campoData['Última Atualização'];
      }
    }

    function popularFiltros() {
      const filtros = [
        'Ano', 'Unidade Orçamentária', 'Natureza de Despesa',
        'Classificação Orçamentária', 'Fonte', 'Empenho', 'CPF/CNPJ', 'Credor'
      ];
      filtros.forEach(filtro => {
        const select = document.getElementById('filtro' + filtro.replace(/[^a-zA-Z]/g, ''));
        if (select) {
          const opcoes = [...new Set(dadosOriginais.map(d => d[filtro]).filter(Boolean))].sort();
          select.innerHTML = '<option value="">Todos</option>' + opcoes.map(o => `<option>${o}</option>`).join('');
          select.onchange = atualizarTabela;
        }
      });
    }

    function atualizarTabela() {
      const ano = document.getElementById('filtroAno').value;
      const unidade = document.getElementById('filtroUnidade').value;
      const natureza = document.getElementById('filtroNatureza').value;
      const classificacao = document.getElementById('filtroClassificacao').value;
      const fonte = document.getElementById('filtroFonte').value;
      const empenho = document.getElementById('filtroEmpenho').value;
      const cpf = document.getElementById('filtroCPF').value;
      const credor = document.getElementById('filtroCredor').value;

      const filtrados = dadosOriginais.filter(d =>
        (!ano || d['Ano'] === ano) &&
        (!unidade || d['Unidade Orçamentária'] === unidade) &&
        (!natureza || d['Natureza de Despesa'] === natureza) &&
        (!classificacao || d['Classificação Orçamentária'] === classificacao) &&
        (!fonte || d['Fonte'] === fonte) &&
        (!empenho || d['Empenho'] === empenho) &&
        (!cpf || d['CPF/CNPJ'] === cpf) &&
        (!credor || d['Credor'] === credor)
      );

      const tabela = document.getElementById('tabelaDados');
      tabela.innerHTML = '';

      if (filtrados.length === 0) {
        tabela.innerHTML = '<tr><td colspan="99">Nenhum dado encontrado.</td></tr>';
        document.getElementById('totais').innerText = '';
        return;
      }

      const colunas = Object.keys(filtrados[0]);
      tabela.innerHTML += '<tr>' + colunas.map(c => `<th>${c}</th>`).join('') + '</tr>';

      let totalEmpenhado = 0, totalLiquidado = 0, totalPago = 0;

      filtrados.forEach(linha => {
        totalEmpenhado += parseValor(linha['Valor Empenhado']);
        totalLiquidado += parseValor(linha['Valor Liquidado']);
        totalPago += parseValor(linha['Valor Pago']);
        tabela.innerHTML += '<tr>' + colunas.map(c => `<td>${linha[c]}</td>`).join('') + '</tr>';
      });

      document.getElementById('totais').innerText =
        `Empenhado: ${formatarMoeda(totalEmpenhado)} | ` +
        `Liquidado: ${formatarMoeda(totalLiquidado)} | ` +
        `Pago: ${formatarMoeda(totalPago)}`;
    }

    carregarDados();
  </script>
</body>
</html>
