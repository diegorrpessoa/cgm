<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Visualizador de Dados Orçamentários</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-2.0.8/b-3.0.1/datatables.min.css"/>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      font-size: x-small;
      background-color: #f8f9fa;
    }
    #overlay, #spinner-ano {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255,255,255,0.8);
      z-index: 9999;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 100px;
      display: none;
    }
    #totalizadores {
      margin: 10px 0;
      font-size: smaller;
    }
    select.form-select {
      font-size: x-small;
      height: auto;
      padding: 0.25rem 0.5rem;
    }
  </style>
</head>
<body class="container-fluid p-3">

  <div id="overlay"><div class="spinner-border text-primary" role="status"></div></div>
  <div id="spinner-ano"><div class="spinner-border text-info" role="status"></div></div>

  <div class="row g-2">
    <div class="col-md-2"><select id="filtroAno" class="form-select"><option value="">Ano</option></select></div>
    <div class="col-md-3"><select id="filtroUO" class="form-select"><option value="">Unidade Orçamentária</option></select></div>
    <div class="col-md-2"><select id="filtroNatureza" class="form-select"><option value="">Natureza de Despesa</option></select></div>
    <div class="col-md-2"><select id="filtroClassificacao" class="form-select"><option value="">Classificação</option></select></div>
    <div class="col-md-2"><select id="filtroFonte" class="form-select"><option value="">Fonte</option></select></div>
    <div class="col-md-1"><button id="resetBtn" class="btn btn-sm btn-secondary w-100">Limpar</button></div>
  </div>

  <div id="totalizadores" class="text-end text-muted mt-2"></div>

  <table id="tabela" class="table table-sm table-striped table-hover mt-3 w-100"></table>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/v/bs5/dt-2.0.8/b-3.0.1/datatables.min.js"></script>
  <script>
    const urlCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTzWz42lwpuf2FwYofqSsAgtDayYLAYCblodcAjQvV-pYxFGengPlHWubJjyTP6_6jidIhpQcuLuvC7/pub?gid=501851609&single=true&output=csv';
    let tabela, dados = [];

    function formatarMoeda(valor) {
      return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function atualizarTotalizadores(data) {
      let empenhado = 0, liquidado = 0, pago = 0;
      data.forEach(row => {
        empenhado += parseFloat(row['Valor Empenhado'] || 0);
        liquidado += parseFloat(row['Valor Liquidado'] || 0);
        pago += parseFloat(row['Valor Pago'] || 0);
      });
      $('#totalizadores').html(`
        <strong>Total Empenhado:</strong> ${formatarMoeda(empenhado)} |
        <strong>Liquidado:</strong> ${formatarMoeda(liquidado)} |
        <strong>Pago:</strong> ${formatarMoeda(pago)}
      `);
    }

    function preencherSelect(id, valores) {
      const select = $(`#${id}`);
      const selecionado = select.val();
      select.empty().append(`<option value="">${select[0].options[0].text}</option>`);
      [...new Set(valores)].sort().forEach(v => select.append(`<option>${v}</option>`));
      if (valores.includes(selecionado)) select.val(selecionado);
    }

    function filtrarDados() {
      const ano = $('#filtroAno').val();
      const uo = $('#filtroUO').val();
      const nat = $('#filtroNatureza').val();
      const cls = $('#filtroClassificacao').val();
      const fonte = $('#filtroFonte').val();

      let filtrado = dados;
      if (ano) filtrado = filtrado.filter(d => d['Ano'] === ano);
      if (uo) filtrado = filtrado.filter(d => d['Unidade Orçamentária'] === uo);
      if (nat) filtrado = filtrado.filter(d => d['Natureza de Despesa'] === nat);
      if (cls) filtrado = filtrado.filter(d => d['Classificação Orçamentária'] === cls);
      if (fonte) filtrado = filtrado.filter(d => d['Fonte'] === fonte);

      atualizarTotalizadores(filtrado);
      tabela.clear().rows.add(filtrado).draw();

      // Atualiza os demais filtros com base na UO
      if (uo) {
        preencherSelect('filtroNatureza', filtrado.map(d => d['Natureza de Despesa']));
        preencherSelect('filtroClassificacao', filtrado.map(d => d['Classificação Orçamentária']));
        preencherSelect('filtroFonte', filtrado.map(d => d['Fonte']));
      } else if (ano) {
        const base = dados.filter(d => d['Ano'] === ano);
        preencherSelect('filtroUO', base.map(d => d['Unidade Orçamentária']));
        preencherSelect('filtroNatureza', base.map(d => d['Natureza de Despesa']));
        preencherSelect('filtroClassificacao', base.map(d => d['Classificação Orçamentária']));
        preencherSelect('filtroFonte', base.map(d => d['Fonte']));
      }
    }

    $(async function () {
      $('#overlay').show();
      const res = await fetch(urlCSV);
      const texto = await res.text();
      const linhas = texto.split('\n').map(l => l.split(','));
      const cabecalho = linhas[0];
      dados = linhas.slice(1).map(l => Object.fromEntries(cabecalho.map((c, i) => [c.trim(), l[i]?.trim()])));

      // Inicializa tabela
      tabela = $('#tabela').DataTable({
        data: dados,
        columns: cabecalho.map(c => ({ title: c, data: c })),
        dom: 'Bfrtip',
        buttons: ['csv', 'excel', 'json', {
          extend: 'copy',
          text: 'TXT',
          fieldSeparator: '\t'
        }],
        scrollX: true,
        paging: true,
        pageLength: 25
      });

      // Filtros iniciais
      preencherSelect('filtroAno', dados.map(d => d['Ano']));
      $('#overlay').hide();

      // Eventos
      $('select').on('change', function () {
        if (this.id === 'filtroAno') $('#spinner-ano').show();
        setTimeout(() => {
          filtrarDados();
          $('#spinner-ano').hide();
        }, 300);
      });

      $('#resetBtn').click(() => {
        $('select').val('');
        tabela.clear().rows.add(dados).draw();
        atualizarTotalizadores(dados);
        preencherSelect('filtroUO', dados.map(d => d['Unidade Orçamentária']));
        preencherSelect('filtroNatureza', dados.map(d => d['Natureza de Despesa']));
        preencherSelect('filtroClassificacao', dados.map(d => d['Classificação Orçamentária']));
        preencherSelect('filtroFonte', dados.map(d => d['Fonte']));
      });

      atualizarTotalizadores(dados);
      preencherSelect('filtroUO', dados.map(d => d['Unidade Orçamentária']));
      preencherSelect('filtroNatureza', dados.map(d => d['Natureza de Despesa']));
      preencherSelect('filtroClassificacao', dados.map(d => d['Classificação Orçamentária']));
      preencherSelect('filtroFonte', dados.map(d => d['Fonte']));
    });
  </script>
</body>
</html>
