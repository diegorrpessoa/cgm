<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta de Despesas</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css"
  />
  <style>
    body {
      font-size: x-small;
    }
    .dataTables_filter {
      display: none;
    }
    .form-label {
      font-size: 0.75rem;
    }
    .form-select-sm,
    .form-control-sm {
      font-size: 0.75rem;
    }
    table.dataTable tbody tr:hover {
      background-color: #f0f8ff;
    }
    table.dataTable {
      border-collapse: separate !important;
      border-spacing: 0 0.3rem !important;
    }
    table.dataTable th,
    table.dataTable td {
      white-space: nowrap;
      vertical-align: middle;
    }
    .totalizadores {
      font-weight: 600;
      font-size: 0.8rem;
      margin-bottom: 1rem;
      user-select: none;
    }
    .totalizadores span {
      margin-right: 1.5rem;
      color: #0d6efd;
    }
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner-overlay-ano {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background-color: rgba(255, 255, 255, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }
    .spinner-border {
      width: 2rem;
      height: 2rem;
    }
    .spinner-text {
      font-size: 0.9rem;
      margin-top: 5px;
      color: #444;
    }
    @media (max-width: 767px) {
      .row.g-2 > div {
        margin-bottom: 0.5rem;
      }
      .totalizadores {
        font-size: 0.7rem;
        margin-bottom: 0.8rem;
      }
    }
  </style>
</head>
<body class="bg-light">

  <!-- Spinner ao carregar CSV -->
  <div id="spinnerCsv" class="spinner-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="spinner-text">Atualizando dados iniciais...</div>
  </div>

  <!-- Spinner ao carregar filtros -->
  <div id="spinnerAno" class="spinner-overlay-ano" style="display:none;">
    <div class="spinner-border text-secondary" role="status"></div>
    <div class="spinner-text">Carregando filtros...</div>
  </div>

  <div class="container my-4">
    <div class="row g-2 mb-3">
      <div class="col-6 col-sm-2">
        <label for="anoFiltro" class="form-label">Ano *</label>
        <select id="anoFiltro" class="form-select form-select-sm" required></select>
      </div>
      <div class="col-6 col-sm-2">
        <label for="mesFiltro" class="form-label">Mês</label>
        <select id="mesFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-6 col-sm-2">
        <label for="unidadeFiltro" class="form-label">Unidade Orçamentária</label>
        <select id="unidadeFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-6 col-sm-2">
        <label for="naturezaFiltro" class="form-label">Natureza de Despesa</label>
        <select id="naturezaFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-6 col-sm-2">
        <label for="classificacaoFiltro" class="form-label">Classificação Orçamentária</label>
        <select id="classificacaoFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-6 col-sm-2">
        <label for="fonteFiltro" class="form-label">Fonte</label>
        <select id="fonteFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-6 col-sm-3">
        <label for="empenhoFiltro" class="form-label">Empenho</label>
        <select id="empenhoFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-6 col-sm-3">
        <label for="cpfFiltro" class="form-label">CPF/CNPJ</label>
        <select id="cpfFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-6 col-sm-3">
        <label for="credorFiltro" class="form-label">Credor</label>
        <select id="credorFiltro" class="form-select form-select-sm" disabled></select>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
      <button class="btn btn-outline-primary btn-sm" id="btnLimpar">Limpar Filtros</button>
      <div class="btn-group">
        <button class="btn btn-outline-secondary btn-sm" id="exportCsv">CSV</button>
        <button class="btn btn-outline-secondary btn-sm" id="exportXls">XLS</button>
        <button class="btn btn-outline-secondary btn-sm" id="exportJson">JSON</button>
        <button class="btn btn-outline-secondary btn-sm" id="exportTxt">TXT</button>
      </div>
    </div>

    <div class="totalizadores mb-3" id="totalizadores" aria-live="polite" aria-atomic="true">
      <span id="totalEmpenhado">Empenhado: R$ 0,00</span>
      <span id="totalLiquidado">Liquidado: R$ 0,00</span>
      <span id="totalPago">Pago: R$ 0,00</span>
    </div>

    <table
      id="tabela"
      class="table table-bordered table-striped table-hover table-sm"
      style="width:100%; display: none;"
      aria-describedby="totalizadores"
    ></table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    let tabela;
    let dadosOriginais = [];
    const mesesOrdem = [
      "Janeiro",
      "Fevereiro",
      "Março",
      "Abril",
      "Maio",
      "Junho",
      "Julho",
      "Agosto",
      "Setembro",
      "Outubro",
      "Novembro",
      "Dezembro",
    ];
    const campos = {
      ano: "Ano",
      mes: "Mês",
      unidade: "Unidade Orçamentária",
      natureza: "Natureza de Despesa",
      classificacao: "Classificação Orçamentária",
      fonte: "Fonte",
      empenho: "Empenho",
      cpf: "CPF/CNPJ",
      credor: "Credor",
      empenhadoVal: "Valor Empenhado",
      liquidadoVal: "Valor Liquidado",
      pagoVal: "Valor Pago",
    };

    // Formata valor para Real brasileiro
    function formatarValor(valor) {
      if (!valor) return "R$ 0,00";
