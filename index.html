<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Consulta de Despesas Públicas</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .container {
            margin-top: 50px;
        }
        .dataTables_wrapper .dataTables_filter input {
            width: 400px;
        }
        tfoot th {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mb-4">Consulta de Despesas Públicas</h1>
        <table id="tabela-despesas" class="display table table-striped" style="width:100%">
            <thead>
                <tr>
                    <th>Unidade Gestora</th>
                    <th>Favorecido</th>
                    <th>CPF/CNPJ</th>
                    <th>Empenho</th>
                    <th>Empenhado</th>
                    <th>Liquidado</th>
                    <th>Pago</th>
                    <th>Histórico</th>
                    <th>Função</th>
                    <th>Subfunção</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <th colspan="4" class="text-end">Totais:</th>
                    <th id="total-empenhado">R$ 0,00</th>
                    <th id="total-liquidado">R$ 0,00</th>
                    <th id="total-pago">R$ 0,00</th>
                    <th colspan="3"></th>
                </tr>
            </tfoot>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script>
        $(document).ready(function () {
            function formatarValor(valor) {
                return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            function atualizarTotalizadoresTabela(dt) {
                let totalEmpenhado = 0, totalLiquidado = 0, totalPago = 0;

                dt.rows({ search: 'applied' }).every(function () {
                    const data = this.data();
                    const vEmp = parseFloat((data.Empenhado || '0').replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
                    const vLiq = parseFloat((data.Liquidado || '0').replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
                    const vPag = parseFloat((data.Pago || '0').replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
                    totalEmpenhado += vEmp;
                    totalLiquidado += vLiq;
                    totalPago += vPag;
                });

                $('#total-empenhado').text(formatarValor(totalEmpenhado));
                $('#total-liquidado').text(formatarValor(totalLiquidado));
                $('#total-pago').text(formatarValor(totalPago));
            }

            const tabela = $('#tabela-despesas').DataTable({
                ajax: function (data, callback) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv';
                    input.onchange = function (event) {
                        const file = event.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const linhas = e.target.result.split('\n').filter(l => l.trim() !== '');
                            const cabecalho = linhas[0].split(';');
                            const dados = linhas.slice(1).map(linha => {
                                const valores = linha.split(';');
                                return Object.fromEntries(cabecalho.map((coluna, i) => [coluna.trim(), valores[i]?.trim() || '']));
                            });
                            callback({ data: dados });

                            setTimeout(() => {
                                atualizarTotalizadoresTabela(tabela);
                            }, 100);
                        };
                        reader.readAsText(file, 'UTF-8');
                    };
                    input.click();
                },
                columns: [
                    { data: 'Unidade Gestora' },
                    { data: 'Favorecido' },
                    { data: 'CPF/CNPJ' },
                    { data: 'Empenho' },
                    { data: 'Empenhado' },
                    { data: 'Liquidado' },
                    { data: 'Pago' },
                    { data: 'Histórico' },
                    { data: 'Função' },
                    { data: 'Subfunção' }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json'
                },
                initComplete: function () {
                    $('.dataTables_filter input').attr('placeholder', 'Buscar por qualquer campo...');
                }
            });

            tabela.on('draw', function () {
                atualizarTotalizadoresTabela(tabela);
            });
        });
    </script>
</body>

</html>
