<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Despesas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
  <style>
    .form-select, .form-control {
      font-size: 0.875rem;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container my-4">
    <h2 class="mb-4 text-center">Consulta de Despesas - 07h02</h2>

    <div class="row g-3 mb-3">
      <div class="col-md-2">
        <label for="anoFiltro" class="form-label">Ano <span class="text-danger">*</span></label>
        <select id="anoFiltro" class="form-select" required></select>
      </div>
      <div class="col-md-2">
        <label for="mesFiltro" class="form-label">Mês</label>
        <select id="mesFiltro" class="form-select" disabled></select>
      </div>
      <div class="col-md-4">
        <label for="unidadeFiltro" class="form-label">Unidade Orçamentária</label>
        <select id="unidadeFiltro" class="form-select" disabled></select>
      </div>
      <div class="col-md-4">
        <label for="cpfFiltro" class="form-label">CNPJ / CPF</label>
        <input type="text" id="cpfFiltro" class="form-control" placeholder="Digite o CPF ou CNPJ" disabled>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <button class="btn btn-outline-secondary" id="btnLimpar">Limpar Filtros</button>
    </div>

    <div class="table-responsive">
      <table id="tabela" class="table table-sm table-striped table-bordered w-100"></table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script>
    let tabelaCompleta = [];
    let tabela;

    function atualizarFiltros() {
      const ano = $('#anoFiltro').val();
      const mes = $('#mesFiltro').val();
      const unidade = $('#unidadeFiltro').val();
      const cpf = $('#cpfFiltro').val().trim();

      let filtrados = tabelaCompleta.filter(item => {
        return (!ano || item.ano === ano) &&
               (!mes || item.mes === mes) &&
               (!unidade || item.unidade === unidade) &&
               (!cpf || item.cpf.includes(cpf));
      });

      atualizarTabela(filtrados);
      popularFiltros(filtrados);
    }

    function atualizarTabela(dados) {
      if ($.fn.DataTable.isDataTable('#tabela')) {
        tabela.clear().rows.add(dados).draw();
      } else {
        tabela = $('#tabela').DataTable({
          data: dados,
          columns: Object.keys(dados[0] || {}).map(col => ({ title: col, data: col })),
          language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"
          },
          pageLength: 10,
          lengthChange: false,
          searching: true
        });
      }
    }

    function popularFiltros(data) {
      const getUnique = (arr, key) => [...new Set(arr.map(item => item[key]).filter(Boolean))];

      const ano = $('#anoFiltro').val();
      const meses = getUnique(data, 'mes');
      const unidades = getUnique(data, 'unidade');

      $('#mesFiltro').empty().append('<option value="">Todos</option>')
        .append(meses.map(m => `<option value="${m}">${m}</option>`));
      $('#unidadeFiltro').empty().append('<option value="">Todas</option>')
        .append(unidades.map(u => `<option value="${u}">${u}</option>`));

      $('#mesFiltro, #unidadeFiltro, #cpfFiltro').prop('disabled', !ano);
    }

    function carregarDados() {
      $.ajax({
        url: 'despesas_25.csv',
        dataType: 'text',
        success: function (csvData) {
          const linhas = csvData.split('\n');
          const colunas = linhas[0].split(',');
          tabelaCompleta = linhas.slice(1).map(linha => {
            const valores = linha.split(',');
            const obj = {};
            colunas.forEach((col, idx) => {
              obj[col.trim()] = valores[idx] ? valores[idx].trim() : '';
            });
            return obj;
          }).filter(item => Object.values(item).some(Boolean));

          const anos = [...new Set(tabelaCompleta.map(l => l.ano))];
          $('#anoFiltro').append('<option value="">Selecione</option>')
            .append(anos.map(ano => `<option value="${ano}">${ano}</option>`));
        }
      });
    }

    $(document).ready(function () {
      carregarDados();

      $('#anoFiltro, #mesFiltro, #unidadeFiltro, #cpfFiltro').on('change keyup', atualizarFiltros);

      $('#btnLimpar').click(() => {
        $('#anoFiltro').val('');
        $('#mesFiltro').val('');
        $('#unidadeFiltro').val('');
        $('#cpfFiltro').val('');
        $('#mesFiltro, #unidadeFiltro, #cpfFiltro').prop('disabled', true);
        atualizarTabela([]);
      });
    });
  </script>
</body>

</html>
