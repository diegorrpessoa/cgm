<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta de Despesas - Apresentação em Cards</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }
    .spinner-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100vh;
      background: rgba(255,255,255,0.6);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .card {
      margin-bottom: 1rem;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .card-header {
      background-color: #0d6efd;
      color: white;
      font-weight: 600;
    }
    .field-label {
      font-weight: 600;
      color: #212529;
    }
    .filters {
      margin-bottom: 1.5rem;
    }
  </style>
</head>
<body>

<div id="spinnerCsv" class="spinner-overlay">
  <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
  <div class="mt-2 fs-5">Carregando dados...</div>
</div>

<div class="container my-4">
  <div class="row g-3 filters">
    <div class="col-md-3">
      <label for="anoFiltro" class="form-label">Ano *</label>
      <select id="anoFiltro" class="form-select" required></select>
    </div>
    <div class="col-md-3">
      <label for="mesFiltro" class="form-label">Mês</label>
      <select id="mesFiltro" class="form-select" disabled></select>
    </div>
    <div class="col-md-3">
      <label for="unidadeFiltro" class="form-label">Unidade Orçamentária</label>
      <select id="unidadeFiltro" class="form-select" disabled></select>
    </div>
    <div class="col-md-3">
      <label for="naturezaFiltro" class="form-label">Natureza de Despesa</label>
      <select id="naturezaFiltro" class="form-select" disabled></select>
    </div>
    <div class="col-md-3 mt-3">
      <label for="classificacaoFiltro" class="form-label">Classificação Orçamentária</label>
      <select id="classificacaoFiltro" class="form-select" disabled></select>
    </div>
    <div class="col-md-3 mt-3">
      <label for="fonteFiltro" class="form-label">Fonte</label>
      <select id="fonteFiltro" class="form-select" disabled></select>
    </div>
    <div class="col-md-3 mt-3">
      <label for="empenhoFiltro" class="form-label">Empenho</label>
      <select id="empenhoFiltro" class="form-select" disabled></select>
    </div>
    <div class="col-md-3 mt-3">
      <label for="cpfFiltro" class="form-label">CPF/CNPJ</label>
      <select id="cpfFiltro" class="form-select" disabled></select>
    </div>
    <div class="col-md-3 mt-3">
      <label for="credorFiltro" class="form-label">Credor</label>
      <select id="credorFiltro" class="form-select" disabled></select>
    </div>
  </div>

  <button id="btnLimpar" class="btn btn-secondary mb-4">Limpar Filtros</button>

  <div id="cardsContainer" class="row"></div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
  const campos = {
    ano: "Ano",
    mes: "Mês",
    unidade: "Unidade Orçamentária",
    natureza: "Natureza de Despesa",
    classificacao: "Classificação Orçamentária",
    fonte: "Fonte",
    empenho: "Empenho",
    cpf: "CPF/CNPJ",
    credor: "Credor"
  };

  const mesesOrdem = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

  let dadosOriginais = [];

  function popularFiltro(id, campo, dados) {
    const filtro = $('#' + id);
    let valores = [...new Set(dados.map(d => d[campo]).filter(v => v && v.trim() !== ''))];

    if(campo === campos.mes) {
      valores.sort((a,b) => mesesOrdem.indexOf(a) - mesesOrdem.indexOf(b));
    } else {
      valores.sort((a,b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }));
    }

    filtro.empty();
    filtro.append('<option value="">Todos</option>');
    valores.forEach(v => filtro.append(`<option value="${v}">${v}</option>`));
    filtro.prop('disabled', false);
  }

  function aplicarFiltros() {
    let dadosFiltrados = dadosOriginais.slice();

    const filtros = {
      ano: $('#anoFiltro').val(),
      mes: $('#mesFiltro').val(),
      unidade: $('#unidadeFiltro').val(),
      natureza: $('#naturezaFiltro').val(),
      classificacao: $('#classificacaoFiltro').val(),
      fonte: $('#fonteFiltro').val(),
      empenho: $('#empenhoFiltro').val(),
      cpf: $('#cpfFiltro').val(),
      credor: $('#credorFiltro').val(),
    };

    Object.entries(filtros).forEach(([key, val]) => {
      if(val) {
        dadosFiltrados = dadosFiltrados.filter(r => r[campos[key]] === val);
      }
    });

    return dadosFiltrados;
  }

  function atualizarFiltrosEncadeados() {
    const anoSelecionado = $('#anoFiltro').val();
    if (!anoSelecionado) {
      // Desabilitar os filtros
      Object.keys(campos).forEach(c => {
        if(c !== 'ano') $('#'+c+'Filtro').prop('disabled', true).val('');
      });
      return;
    }
    let dadosAno = dadosOriginais.filter(d => d[campos.ano] === anoSelecionado);

    popularFiltro("mesFiltro", campos.mes, dadosAno);
    popularFiltro("unidadeFiltro", campos.unidade, dadosAno);
    popularFiltro("naturezaFiltro", campos.natureza, dadosAno);
    popularFiltro("classificacaoFiltro", campos.classificacao, dadosAno);
    popularFiltro("fonteFiltro", campos.fonte, dadosAno);
    popularFiltro("empenhoFiltro", campos.empenho, dadosAno);
    popularFiltro("cpfFiltro", campos.cpf, dadosAno);
    popularFiltro("credorFiltro", campos.credor, dadosAno);
  }

  function criarCard(registro) {
    return `
      <div class="col-md-6 col-lg-4">
        <div class="card">
          <div class="card-header">Ano: ${registro[campos.ano]} - Mês: ${registro[campos.mes]}</div>
          <div class="card-body">
            <p><span class="field-label">Unidade Orçamentária:</span> ${registro[campos.unidade]}</p>
            <p><span class="field-label">Natureza de Despesa:</span> ${registro[campos.natureza]}</p>
            <p><span class="field-label">Classificação Orçamentária:</span> ${registro[campos.classificacao]}</p>
            <p><span class="field-label">Fonte:</span> ${registro[campos.fonte]}</p>
            <p><span class="field-label">Empenho:</span> ${registro[campos.empenho]}</p>
            <p><span class="field-label">CPF/CNPJ:</span> ${registro[campos.cpf]}</p>
            <p><span class="field-label">Credor:</span> ${registro[campos.credor]}</p>
          </div>
        </div>
      </div>`;
  }

  function mostrarCards(dados) {
    const container = $('#cardsContainer');
    container.empty();

    if(dados.length === 0) {
      container.html('<p class="text-muted">Nenhum dado encontrado para os filtros selecionados.</p>');
      return;
    }

    const cards = dados.map(criarCard).join('');
    container.html(cards);
  }

  $(document).ready(function () {
    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vTzWz42lwpuf2FwYofqSsAgtDayYLAYCblodcAjQvV-pYxFGengPlHWubJjyTP6_6jidIhpQcuLuvC7/pub?gid=501851609&single=true&output=csv", {
      download: true,
      header: true,
      complete: function (results) {
        dadosOriginais = results.data.filter(r => r[campos.ano]);

        popularFiltro("anoFiltro", campos.ano, dadosOriginais);

        $('#spinnerCsv').hide();

        $('#anoFiltro').on('change', () => {
          atualizarFiltrosEncadeados();
          mostrarCards(aplicarFiltros());
        });

        $('select').not('#anoFiltro').on('change', () => {
          mostrarCards(aplicarFiltros());
        });

        $('#btnLimpar').click(() => {
          $('select').val('');
          $('select').not('#anoFiltro').prop('disabled', true);
          $('#cardsContainer').empty();
        });
      }
    });
  });
</script>

</body>
</html>
