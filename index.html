<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta de Despesas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css" />
  <style>
    body {
      font-size: 0.75rem;
      background-color: #f8f9fa;
    }
    .dataTables_filter {
      display: none;
    }
    .form-label {
      font-size: 0.75rem;
      font-weight: 600;
    }
    .form-select-sm, .form-control-sm {
      font-size: 0.75rem;
      padding: 0.25rem 0.4rem;
      height: 1.8rem;
    }
    .table thead th {
      vertical-align: middle;
      background-color: #343a40;
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
    }
    .table tbody td {
      vertical-align: middle;
      white-space: nowrap;
      padding: 0.25rem 0.5rem;
    }
    .table-striped > tbody > tr:nth-of-type(odd) {
      background-color: #e9ecef;
    }
    .btn-sm {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
    }
    .spinner-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100vh;
      background-color: rgba(255, 255, 255, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 0.9rem;
      font-weight: 600;
      color: #0d6efd;
    }
    .spinner-overlay-ano {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100vh;
      background-color: rgba(255, 255, 255, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      font-size: 0.85rem;
      font-weight: 600;
      color: #6c757d;
    }
    .spinner-border {
      width: 1.8rem;
      height: 1.8rem;
      margin-bottom: 0.3rem;
    }
    #totalizadores {
      font-size: 0.8rem;
      font-weight: 600;
      color: #212529;
      background-color: #e2e6ea;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      user-select: none;
    }
    #totalizadores span {
      margin-right: 1.5rem;
    }
    @media (max-width: 1200px) {
      .table thead th, .table tbody td {
        white-space: normal;
      }
    }
  </style>
</head>
<body>

  <!-- Spinner ao carregar CSV -->
  <div id="spinnerCsv" class="spinner-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    Atualizando dados iniciais...
  </div>

  <!-- Spinner ao carregar filtros -->
  <div id="spinnerAno" class="spinner-overlay-ano" style="display:none;">
    <div class="spinner-border text-secondary" role="status"></div>
    Carregando filtros...
  </div>

  <div class="container my-3">
    <div class="row g-2 mb-2">
      <div class="col-auto">
        <label for="anoFiltro" class="form-label">Ano *</label>
        <select id="anoFiltro" class="form-select form-select-sm" required></select>
      </div>
      <div class="col-auto">
        <label for="mesFiltro" class="form-label">Mês</label>
        <select id="mesFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-auto">
        <label for="unidadeFiltro" class="form-label">Unidade Orçamentária</label>
        <select id="unidadeFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-auto">
        <label for="naturezaFiltro" class="form-label">Natureza de Despesa</label>
        <select id="naturezaFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-auto">
        <label for="classificacaoFiltro" class="form-label">Classificação Orçamentária</label>
        <select id="classificacaoFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-auto">
        <label for="fonteFiltro" class="form-label">Fonte</label>
        <select id="fonteFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-auto">
        <label for="empenhoFiltro" class="form-label">Empenho</label>
        <select id="empenhoFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-auto">
        <label for="cpfFiltro" class="form-label">CPF/CNPJ</label>
        <select id="cpfFiltro" class="form-select form-select-sm" disabled></select>
      </div>
      <div class="col-auto">
        <label for="credorFiltro" class="form-label">Credor</label>
        <select id="credorFiltro" class="form-select form-select-sm" disabled></select>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
      <button class="btn btn-outline-primary btn-sm" id="btnLimpar">Limpar Filtros</button>
      <div class="btn-group">
        <button class="btn btn-outline-secondary btn-sm" id="exportCsv">CSV</button>
        <button class="btn btn-outline-secondary btn-sm" id="exportXls">XLS</button>
        <button class="btn btn-outline-secondary btn-sm" id="exportJson">JSON</button>
        <button class="btn btn-outline-secondary btn-sm" id="exportTxt">TXT</button>
      </div>
      <div id="totalizadores" class="ms-auto">
        <span>Empenhado: <span id="totalEmpenhado">0,00</span></span>
        <span>Liquidado: <span id="totalLiquidado">0,00</span></span>
        <span>Pago: <span id="totalPago">0,00</span></span>
      </div>
    </div>

    <table id="tabela" class="table table-bordered table-striped table-sm" style="width:100%; display:none;"></table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    let tabela;
    let dadosOriginais = [];
    const campos = {
      ano: "Ano",
      mes: "Mês",
      unidade: "Unidade Orçamentária",
      natureza: "Natureza de Despesa",
      classificacao: "Classificação Orçamentária",
      fonte: "Fonte",
      empenho: "Empenho",
      cpf: "CPF/CNPJ",
      credor: "Credor",
      empenhado: "Valor Empenhado",
      liquidado: "Valor Liquidado",
      pago: "Valor Pago"
    };

    // Ordem fixa para meses em português
    const mesesOrdem = [
      "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
      "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
    ];

    // Mostra/oculta spinners
    function spinner(show, ano = false) {
      if (ano) {
        document.getElementById("spinnerAno").style.display = show ? "flex" : "none";
      } else {
        document.getElementById("spinnerCsv").style.display = show ? "flex" : "none";
      }
    }

    // Formata número para moeda BRL
    function formatarBRL(valor) {
      let num = Number(valor);
      if (isNaN(num)) return "0,00";
      return num.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Remove duplicados e ordena, tratando mês especialmente
    function valoresUnicosOrdenados(dados, campo) {
      let valores = dados
        .map(d => (d[campo] || "").trim())
        .filter(v => v !== "");

      if (campo === campos.mes) {
        valores = [...new Set(valores)].filter(v => mesesOrdem.includes(v));
        valores.sort((a, b) => mesesOrdem.indexOf(a) - mesesOrdem.indexOf(b));
      } else {
        valores = [...new Set(valores)].sort((a, b) =>
          a.localeCompare(b, "pt-BR", { sensitivity: "base" })
        );
      }
      return valores;
    }

    // Atualiza opções de um select
    function atualizarOpcoesSelect(idSelect, valores, habilitar = true, placeholder = "Todos") {
      const select = document.getElementById(idSelect);
      select.innerHTML = `<option value="">${placeholder}</option>`;
      valores.forEach(v => {
        select.innerHTML += `<option value="${v}">${v}</option>`;
      });
      select.disabled = !habilitar;
    }

    // Aplica filtros aos dados
    function aplicarFiltros() {
      let ano = document.getElementById("anoFiltro").value.trim();
      let mes = document.getElementById("mesFiltro").value.trim();
      let unidade = document.getElementById("unidadeFiltro").value.trim();
      let natureza = document.getElementById("naturezaFiltro").value.trim();
      let classificacao = document.getElementById("classificacaoFiltro").value.trim();
      let fonte = document.getElementById("fonteFiltro").value.trim();
      let empenho = document.getElementById("empenhoFiltro").value.trim();
      let cpf = document.getElementById("cpfFiltro").value.trim();
      let credor = document.getElementById("credorFiltro").value.trim();

      let filtrados = dadosOriginais.filter(d => {
        if (ano && d[campos.ano] !== ano) return false;
        if (mes && d[campos.mes] !== mes) return false;
        if (unidade && d[campos.unidade] !== unidade) return false;
        if (natureza && d[campos.natureza] !== natureza) return false;
        if (classificacao && d[campos.classificacao] !== classificacao) return false;
        if (fonte && d[campos.fonte] !== fonte) return false;
        if (empenho && d[campos.empenho] !== empenho) return false;
        if (cpf && d[campos.cpf] !== cpf) return false;
        if (credor && d[campos.credor] !== credor) return false;
        return true;
      });
      return filtrados;
    }

    // Atualiza filtros dependentes (exceto ano que é principal)
    function atualizarFiltrosDependentes() {
      spinner(true, true);

      setTimeout(() => {
        let ano = document.getElementById("anoFiltro").value.trim();
        if (!ano) {
          // Desabilita todos os outros filtros
          ["mesFiltro","unidadeFiltro","naturezaFiltro","classificacaoFiltro","fonteFiltro","empenhoFiltro","cpfFiltro","credorFiltro"].forEach(id => {
            atualizarOpcoesSelect(id, [], false);
          });
          spinner(false, true);
          return;
        }

        // Filtra dados só pelo ano
        let dadosAno = dadosOriginais.filter(d => d[campos.ano] === ano);

        // Se unidade selecionada, filtra demais pelos dados dessa unidade
        let unidadeSelecionada = document.getElementById("unidadeFiltro").value.trim();

        // Base para os filtros: se unidade selecionada, filtra pelos dados ano+unidade, senão só ano
        let baseFiltros = unidadeSelecionada
          ? dadosAno.filter(d => d[campos.unidade] === unidadeSelecionada)
          : dadosAno;

        // Atualiza os filtros com baseFiltros (ou dadosAno se unidade não selecionada)
        atualizarOpcoesSelect("mesFiltro", valoresUnicosOrdenados(baseFiltros, campos.mes), true, "Todos");
        atualizarOpcoesSelect("naturezaFiltro", valoresUnicosOrdenados(baseFiltros, campos.natureza), true, "Todos");
        atualizarOpcoesSelect("classificacaoFiltro", valoresUnicosOrdenados(baseFiltros, campos.classificacao), true, "Todos");
        atualizarOpcoesSelect("fonteFiltro", valoresUnicosOrdenados(baseFiltros, campos.fonte), true, "Todos");
        atualizarOpcoesSelect("empenhoFiltro", valoresUnicosOrdenados(baseFiltros, campos.empenho), true, "Todos");
        atualizarOpcoesSelect("cpfFiltro", valoresUnicosOrdenados(baseFiltros, campos.cpf), true, "Todos");
        atualizarOpcoesSelect("credorFiltro", valoresUnicosOrdenados(baseFiltros, campos.credor), true, "Todos");

        spinner(false, true);
      }, 150);
    }

    // Atualiza tabela e totalizadores
    function atualizarTabela() {
      const dadosFiltrados = aplicarFiltros();

      // Atualiza totalizadores
      let totalEmpenhado = 0, totalLiquidado = 0, totalPago = 0;
      dadosFiltrados.forEach(d => {
        totalEmpenhado += parseFloat(d[campos.empenhado].replace(/[^\d.,-]/g, "").replace(",", ".") || 0);
        totalLiquidado += parseFloat(d[campos.liquidado].replace(/[^\d.,-]/g, "").replace(",", ".") || 0);
        totalPago += parseFloat(d[campos.pago].replace(/[^\d.,-]/g, "").replace(",", ".") || 0);
      });
      document.getElementById("totalEmpenhado").textContent = formatarBRL(totalEmpenhado);
      document.getElementById("totalLiquidado").textContent = formatarBRL(totalLiquidado);
      document.getElementById("totalPago").textContent = formatarBRL(totalPago);

      // Recria tabela DataTables
      if (tabela) tabela.clear().destroy();

      if (dadosFiltrados.length === 0) {
        document.getElementById("tabela").style.display = "none";
        return;
      }

      const colunas = Object.keys(campos).map(campo => ({
        title: campos[campo],
        data: campos[campo],
        render: (data, type, row) => {
          // Formatar valores monetários para as colunas corretas
          if ([campos.empenhado, campos.liquidado, campos.pago].includes(campo)) {
            return formatarBRL(data);
          }
          return data || "";
        }
      }));

      document.getElementById("tabela").style.display = "table";

      tabela = $("#tabela").DataTable({
        data: dadosFiltrados,
        columns: colunas,
        ordering: true,
        searching: false,
        paging: true,
        lengthChange: false,
        pageLength: 25,
        language: {
          url: "https://cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"
        },
        dom: 'Bfrtip',
        buttons: [
          {
            extend: 'csvHtml5',
            text: 'CSV',
            className: 'btn btn-outline-secondary btn-sm',
            filename: 'dados_filtrados'
          },
          {
            extend: 'excelHtml5',
            text: 'XLS',
            className: 'btn btn-outline-secondary btn-sm',
            filename: 'dados_filtrados'
          },
          {
            extend: 'json',
            text: 'JSON',
            className: 'btn btn-outline-secondary btn-sm',
            action: function ( e, dt, node, config ) {
              const json = JSON.stringify(dt.rows({ search: 'applied' }).data().toArray(), null, 2);
              const blob = new Blob([json], {type: "application/json"});
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "dados_filtrados.json";
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(url);
            }
          },
          {
            text: 'TXT',
            className: 'btn btn-outline-secondary btn-sm',
            action: function ( e, dt, node, config ) {
              const rows = dt.rows({ search: 'applied' }).data().toArray();
              let txt = "";
              if(rows.length > 0) {
                // Cabeçalho
                txt += Object.values(campos).join("\t") + "\n";
                rows.forEach(row => {
                  txt += Object.keys(campos).map(k => row[campos[k]] || "").join("\t") + "\n";
                });
              }
              const blob = new Blob([txt], {type: "text/plain"});
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "dados_filtrados.txt";
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(url);
            }
          }
        ]
      });
    }

    // Inicializa selects, liga eventos e carrega CSV
    async function inicializar() {
      spinner(true, false);

      // URL pública do CSV da planilha (ajuste conforme necessário)
      const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzWz42lwpuf2FwYofqSsAgtDayYLAYCblodcAjQvV-pYxFGengPlHWubJjyTP6_6jidIhpQcuLuvC7/pub?gid=501851609&single=true&output=csv";

      try {
        const resposta = await fetch(csvUrl);
        const csvTexto = await resposta.text();

        // Parse CSV com PapaParse
        const parsed = Papa.parse(csvTexto, { header: true, skipEmptyLines: true });
        dadosOriginais = parsed.data;

        // Preenche filtro ano
        const anos = valoresUnicosOrdenados(dadosOriginais, campos.ano);
        atualizarOpcoesSelect("anoFiltro", anos, true, "Selecione o ano");

        // Inicialmente desabilita os demais filtros
        ["mesFiltro","unidadeFiltro","naturezaFiltro","classificacaoFiltro","fonteFiltro","empenhoFiltro","cpfFiltro","credorFiltro"].forEach(id => {
          atualizarOpcoesSelect(id, [], false);
        });

        spinner(false, false);
      } catch (err) {
        spinner(false, false);
        alert("Erro ao carregar dados CSV: " + err.message);
      }
    }

    // Evento mudança filtro ano
    document.getElementById("anoFiltro").addEventListener("change", () => {
      atualizarFiltrosDependentes();
      atualizarTabela();
    });

    // Eventos para os demais filtros
    ["mesFiltro","unidadeFiltro","naturezaFiltro","classificacaoFiltro","fonteFiltro","empenhoFiltro","cpfFiltro","credorFiltro"].forEach(id => {
      document.getElementById(id).addEventListener("change", () => {
        if(id === "unidadeFiltro") {
          atualizarFiltrosDependentes();
        } else {
          atualizarTabela();
        }
      });
    });

    // Botão limpar filtros
    document.getElementById("btnLimpar").addEventListener("click", () => {
      document.getElementById("anoFiltro").value = "";
      ["mesFiltro","unidadeFiltro","naturezaFiltro","classificacaoFiltro","fonteFiltro","empenhoFiltro","cpfFiltro","credorFiltro"].forEach(id => {
        atualizarOpcoesSelect(id, [], false);
      });
      document.getElementById("tabela").style.display = "none";
      document.getElementById("totalEmpenhado").textContent = "0,00";
      document.getElementById("totalLiquidado").textContent = "0,00";
      document.getElementById("totalPago").textContent = "0,00";
    });

    // Inicializa tudo
    inicializar();

  </script>
</body>
</html>
