<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Despesas Públicas</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
  <div class="container mt-4">
    <h2 class="mb-4">Teste Despesas Públicas</h2>
    <table id="tabela" class="display nowrap table table-striped" style="width:100%">
      <thead>
        <tr>
          <th>Órgão</th>
          <th>Unidade Gestora</th>
          <th>Função</th>
          <th>Subfunção</th>
          <th>Programa</th>
          <th>Ação</th>
          <th>Elemento de Despesa</th>
          <th>Empenhado</th>
          <th>Liquidado</th>
          <th>Pago</th>
        </tr>
      </thead>
      <tfoot>
        <tr>
          <th colspan="7" style="text-align:right">Totais:</th>
          <th></th>
          <th></th>
          <th></th>
        </tr>
      </tfoot>
      <tbody>
        <!-- Os dados do CSV serão carregados aqui -->
      </tbody>
    </table>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function formatarValor(valor) {
      return parseFloat(valor.replace(/[R$\.\s]/g, '').replace(',', '.')) || 0;
    }

    $(document).ready(function() {
      const tabela = $('#tabela').DataTable({
        dom: 'Bfrtip',
        buttons: ['copy', 'csv', 'excel', 'print'],
        scrollX: true,
        footerCallback: function (row, data, start, end, display) {
          const api = this.api();

          // Função auxiliar para somar colunas
          function somarColuna(index) {
            return api
              .column(index, { search: 'applied' })
              .data()
              .reduce(function (a, b) {
                return formatarValor(a) + formatarValor(b);
              }, 0);
          }

          const totalEmpenhado = somarColuna(7);
          const totalLiquidado = somarColuna(8);
          const totalPago = somarColuna(9);

          // Atualiza os totais formatados no rodapé
          $(api.column(7).footer()).html(totalEmpenhado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }));
          $(api.column(8).footer()).html(totalLiquidado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }));
          $(api.column(9).footer()).html(totalPago.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }));
        }
      });

      // Carregamento do CSV
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.csv';
      input.style.display = 'block';
      input.className = 'form-control mt-3';
      document.querySelector('.container').prepend(input);

      input.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
              tabela.clear();
              results.data.forEach(function (row) {
                tabela.row.add([
                  row['Órgão'],
                  row['Unidade Gestora'],
                  row['Função'],
                  row['Subfunção'],
                  row['Programa'],
                  row['Ação'],
                  row['Elemento de Despesa'],
                  row['Empenhado'],
                  row['Liquidado'],
                  row['Pago']
                ]);
              });
              tabela.draw();
            }
          });
        }
      });
    });
  </script>
</body>
</html>
