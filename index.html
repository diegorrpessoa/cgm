<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Despesas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker.min.css">
  <style>
    .datepicker-dropdown {
      z-index: 9999 !important;
    }
    .dataTables_paginate .pagination {
      justify-content: center;
    }
    .dataTables_wrapper .dataTables_info {
      text-align: center;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container my-4">
    <h4 class="mb-4 text-center fw-bold">Despesas 2025</h4>

    <div class="row g-2 mb-3 small">
      <div class="col-md-2">
        <label for="mesFiltro" class="form-label">Mês</label>
        <select id="mesFiltro" class="form-select form-select-sm"></select>
      </div>
      <div class="col-md-2">
        <label for="anoFiltro" class="form-label">Ano</label>
        <select id="anoFiltro" class="form-select form-select-sm"></select>
      </div>
      <div class="col-md-3">
        <label for="unidadeFiltro" class="form-label">Unidade Orçamentária</label>
        <select id="unidadeFiltro" class="form-select form-select-sm"></select>
      </div>
      <div class="col-md-3">
        <label for="cpfFiltro" class="form-label">CNPJ / CPF</label>
        <input type="text" id="cpfFiltro" class="form-control form-control-sm" placeholder="Digite o CPF ou CNPJ">
      </div>
      <div class="col-md-1">
        <label for="dataDeFiltro" class="form-label">Data De</label>
        <input type="text" id="dataDeFiltro" class="form-control form-control-sm datepicker" placeholder="dd-mm-aaaa">
      </div>
      <div class="col-md-1">
        <label for="dataFiltro" class="form-label">Até</label>
        <input type="text" id="dataFiltro" class="form-control form-control-sm datepicker" placeholder="dd-mm-aaaa">
      </div>
    </div>

    <div class="d-flex justify-content-between mb-3">
      <button class="btn btn-sm btn-outline-primary" id="btnLimpar">Limpar Filtros</button>
      <div class="btn-group btn-group-sm">
        <button class="btn btn-outline-secondary" id="exportCsv">CSV</button>
        <button class="btn btn-outline-secondary" id="exportXls">XLS</button>
        <button class="btn btn-outline-secondary" id="exportJson">JSON</button>
        <button class="btn btn-outline-secondary" id="exportTxt">TXT</button>
        <button class="btn btn-outline-secondary" id="exportPdf">PDF</button>
      </div>
    </div>

    <table id="tabela" class="table table-sm table-striped table-bordered"></table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/locales/bootstrap-datepicker.pt-BR.min.js"></script>
  <script>
    $.extend(true, $.fn.dataTable.defaults, {
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"
      }
    });
  </script><script>
    $.datepicker.setDefaults($.datepicker.regional['pt-BR'] = {
      closeText: 'Fechar', prevText: '<Anterior', nextText: 'Próximo>',
      currentText: 'Hoje', monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'],
      monthNamesShort: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
      dayNames: ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'],
      dayNamesShort: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'],
      dayNamesMin: ['D','S','T','Q','Q','S','S'],
      dateFormat: 'yy-mm-dd'
    });
    $(function () {
      $("#dataInicio, #dataFim").datepicker();
    });

    Papa.parse('despesas_25.csv', {
      download: true,
      header: true,
      complete: function (results) {
        let data = results.data.filter(row => Object.values(row).some(val => val !== ""));
        const colunas = Object.keys(data[0]).map(col => ({ title: col, data: col }));
        const tabela = $('#tabela').DataTable({
          data: data,
          columns: colunas,
          language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json' },
          initComplete: function () {
            atualizarFiltros();
          }
        });

        function atualizarFiltros() {
          atualizarDropdown('filtroAno', 'ano');
          atualizarDropdown('filtroMes', 'mes');
          atualizarDropdown('filtroUO', 'unidade orcamentaria');
        }

        function atualizarDropdown(id, campo) {
          const valEmpenho = $('#filtroEmpenho').val().toLowerCase();
          const valCNPJ = $('#filtroCNPJ').val().toLowerCase();
          const inicio = $('#dataInicio').val();
          const fim = $('#dataFim').val();

          let filtrado = data.filter(d => {
            let match = true;
            if (valEmpenho && !d['empenho'].toLowerCase().includes(valEmpenho)) match = false;
            if (valCNPJ && !d['cpf-cnpj'].toLowerCase().includes(valCNPJ)) match = false;
            const dataEmp = new Date(d['data do empenho']);
            if (inicio && new Date(inicio) > dataEmp) match = false;
            if (fim && new Date(fim) < dataEmp) match = false;
            return match;
          });

          if ($('#filtroAno').val()) filtrado = filtrado.filter(r => r['ano'] === $('#filtroAno').val());
          if ($('#filtroMes').val()) filtrado = filtrado.filter(r => r['mes'] === $('#filtroMes').val());
          if ($('#filtroUO').val()) filtrado = filtrado.filter(r => r['unidade orcamentaria'] === $('#filtroUO').val());

          const unicos = [...new Set(filtrado.map(d => d[campo]).filter(Boolean))].sort();
          const select = $('#' + id);
          const selecionado = select.val();
          select.empty().append('<option value="">Todos</option>');
          unicos.forEach(v => select.append(`<option value="${v}">${v}</option>`));
          if (unicos.includes(selecionado)) select.val(selecionado);
        }

        $('#filtroAno, #filtroMes, #filtroUO, #filtroEmpenho, #filtroCNPJ, #dataInicio, #dataFim').on('change keyup', function () {
          const filtros = {
            ano: $('#filtroAno').val(),
            mes: $('#filtroMes').val(),
            uo: $('#filtroUO').val(),
            empenho: $('#filtroEmpenho').val().toLowerCase(),
            cnpj: $('#filtroCNPJ').val().toLowerCase(),
            inicio: $('#dataInicio').val(),
            fim: $('#dataFim').val()
          };
          tabela.clear().rows.add(data.filter(d => {
            return (!filtros.ano || d['ano'] === filtros.ano)
              && (!filtros.mes || d['mes'] === filtros.mes)
              && (!filtros.uo || d['unidade orcamentaria'] === filtros.uo)
              && (!filtros.empenho || d['empenho'].toLowerCase().includes(filtros.empenho))
              && (!filtros.cnpj || d['cpf-cnpj'].toLowerCase().includes(filtros.cnpj))
              && (!filtros.inicio || new Date(d['data do empenho']) >= new Date(filtros.inicio))
              && (!filtros.fim || new Date(d['data do empenho']) <= new Date(filtros.fim));
          })).draw();
          atualizarFiltros();
        });

        $('#limparFiltros').on('click', function () {
          $('#filtros select, #filtros input').val('');
          tabela.clear().rows.add(data).draw();
          atualizarFiltros();
        });
      }
    });
  </script>
</body>
</html>
