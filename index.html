<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Despesas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker.min.css">
  <style>
    .datepicker-dropdown {
      z-index: 9999 !important;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container my-4">
    <h2 class="mb-4 text-center">Consulta de Despesas</h2>

    <div class="row g-3 mb-4">
      <div class="col-md-2">
        <label for="mesFiltro" class="form-label">Mês</label>
        <select id="mesFiltro" class="form-select"><option value="">Todos</option></select>
      </div>
      <div class="col-md-2">
        <label for="anoFiltro" class="form-label">Ano</label>
        <select id="anoFiltro" class="form-select"><option value="">Todos</option></select>
      </div>
      <div class="col-md-3">
        <label for="unidadeFiltro" class="form-label">Unidade Orçamentária</label>
        <select id="unidadeFiltro" class="form-select"><option value="">Todas</option></select>
      </div>
      <div class="col-md-3">
        <label for="cpfFiltro" class="form-label">CNPJ / CPF</label>
        <input type="text" id="cpfFiltro" class="form-control" placeholder="Digite o CPF ou CNPJ">
      </div>
      <div class="col-md-2">
        <label for="dataFiltro" class="form-label">Data Até</label>
        <input type="text" id="dataFiltro" class="form-control datepicker" placeholder="dd-mm-aaaa">
      </div>
    </div>

    <div class="d-flex justify-content-between mb-3">
      <div>
        <button class="btn btn-outline-primary me-2" id="btnLimpar">Limpar Filtros</button>
      </div>
      <div class="btn-group">
        <button class="btn btn-outline-secondary" id="exportCsv">Exportar CSV</button>
        <button class="btn btn-outline-secondary" id="exportXls">Exportar XLS</button>
        <button class="btn btn-outline-secondary" id="exportJson">Exportar JSON</button>
        <button class="btn btn-outline-secondary" id="exportTxt">Exportar TXT</button>
        <button class="btn btn-outline-secondary" id="exportPdf">Exportar PDF</button>
      </div>
    </div>

    <table id="tabela" class="table table-striped table-bordered" style="width:100%"></table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/locales/bootstrap-datepicker.pt-BR.min.js"></script>
  <script>
    $(document).ready(function () {
      $('.datepicker').datepicker({
        format: 'dd-mm-yyyy',
        language: 'pt-BR',
        autoclose: true
      });

      $.ajax({
        url: 'despesas_25.csv',
        dataType: 'text',
        success: function (data) {
          const linhas = data.split("\n");
          const cabecalho = linhas[0].split(',');
          const registros = linhas.slice(1).map(linha => {
            const valores = linha.split(',');
            const obj = {};
            cabecalho.forEach((col, i) => obj[col.trim()] = valores[i]);
            return obj;
          });

          const table = $('#tabela').DataTable({
            data: registros,
            columns: cabecalho.map(c => ({ title: c, data: c })),
            dom: 'Bfrtip',
            buttons: [
              { extend: 'csvHtml5', className: 'd-none buttons-csv' },
              { extend: 'excelHtml5', className: 'd-none buttons-excel' },
              { extend: 'copyHtml5', className: 'd-none buttons-copy' },
              { extend: 'pdfHtml5', className: 'd-none buttons-pdf' }
            ]
          });

          function atualizarFiltros(coluna, seletor) {
            const valores = [...new Set(registros.map(r => r[coluna]).filter(Boolean))].sort();
            valores.forEach(v => $(seletor).append(`<option value="${v}">${v}</option>`));
          }

          atualizarFiltros('mes', '#mesFiltro');
          atualizarFiltros('ano', '#anoFiltro');
          atualizarFiltros('unidade orcamentaria', '#unidadeFiltro');

          function aplicarFiltros() {
            const mes = $('#mesFiltro').val();
            const ano = $('#anoFiltro').val();
            const unidade = $('#unidadeFiltro').val();
            const cpf = $('#cpfFiltro').val().toLowerCase();
            const data = $('#dataFiltro').val();

            table.clear().rows.add(registros.filter(r => {
              return (!mes || r['mes'] === mes)
                && (!ano || r['ano'] === ano)
                && (!unidade || r['unidade orcamentaria'] === unidade)
                && (!cpf || (r['cpf-cnpj'] && r['cpf-cnpj'].toLowerCase().includes(cpf)))
                && (!data || (r['data'] && r['data'].split('-').reverse().join('-') <= data.split('-').reverse().join('-')));
            })).draw();
          }

          $('#mesFiltro, #anoFiltro, #unidadeFiltro, #cpfFiltro, #dataFiltro').on('change keyup', aplicarFiltros);

          $('#btnLimpar').click(() => {
            $('#mesFiltro, #anoFiltro, #unidadeFiltro').val('');
            $('#cpfFiltro, #dataFiltro').val('');
            aplicarFiltros();
          });

          $('#exportCsv').click(() => $('.buttons-csv').click());
          $('#exportXls').click(() => $('.buttons-excel').click());
          $('#exportJson').click(() => alert('Exportação para JSON não implementada.'));
          $('#exportTxt').click(() => $('.buttons-copy').click());
          $('#exportPdf').click(() => $('.buttons-pdf').click());
        }
      });
    });
  </script>
</body>

</html>
